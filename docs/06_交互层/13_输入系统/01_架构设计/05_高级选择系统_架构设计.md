---
文档类型: 架构设计
创建日期: 2026-02-09
最后更新: 2026-02-09
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级选择系统（框选/编组/跨平台）
状态: 设计中
---
# 高级选择系统 — 架构设计

## 1 现状

- Core 层 `EntityClickSelectSystem` 仅支持单击选中单个实体
- Demo/Mod 层已有框选原型（`SimpleRtsControllerSystem`、`Physics2DPlaygroundPresentationSystem`）
- 多选通过 `SelectedTag` 标记组件实现，但无编组、双击同类等高级功能
- 输入系统使用 Action ID（跨平台），不绑定具体按键

## 2 Core 层组件设计

### 2.1 SelectionBuffer

替代单一 `SelectedTag`，支持多选列表。

```csharp
public unsafe struct SelectionBuffer
{
    public const int MAX_SELECTED = 64;
    public fixed int SelectedEntityIds[MAX_SELECTED * 3]; // Entity triplet (Id, WorldId, Version)
    public int Count;
}
```

### 2.2 SelectionGroupBuffer

10 个编组，每组最多 64 实体。Ctrl+数字存储，数字键恢复。

```csharp
public unsafe struct SelectionGroupBuffer
{
    public const int MAX_GROUPS = 10;
    public const int MAX_PER_GROUP = 64;
    // 展平存储
    public fixed int GroupEntityIds[MAX_GROUPS * MAX_PER_GROUP * 3];
    public fixed int GroupCounts[MAX_GROUPS];
}
```

### 2.3 ISelectionInputHandler

可拆装接口，Core 定义，前端实现。

```csharp
public interface ISelectionInputHandler
{
    void ClickSelect(Entity entity, bool additive);
    void BoxSelect(Vector2 screenStart, Vector2 screenEnd, bool additive);
    void DoubleClickSelect(Entity entity); // 选中同类
    void SaveGroup(int groupIndex);
    void RecallGroup(int groupIndex);
}
```

## 3 输入映射（跨平台）

使用 Action ID，不绑定具体按键名：

| Action ID | 默认 PC 绑定 | 说明 |
|---|---|---|
| `Select` | 鼠标左键 | 主选择 |
| `SelectAdd` | Shift 修饰 | 加选/减选修饰符 |
| `SelectGroup0`~`SelectGroup9` | 0-9 | 编组存取 |
| `SelectSameType` | 双击 | 双击同类选中 |
| `BoxSelectStart` | 鼠标左键按下 | 框选起点 |
| `BoxSelectEnd` | 鼠标左键松开 | 框选终点 |

## 4 数据流

选择变化产生 Blackboard 数据变化：

```
用户输入 → ISelectionInputHandler
  → 更新 SelectionBuffer Component
  → 写入 BB Key: SelectedEntities
  → 下游系统读取 BB / SelectionBuffer
```

选择不是纯前端状态——它影响 Order 构建（谁执行 Order）和 AI（推荐目标列表）。

## 5 框选提取

Demo/Mod 中已有原型代码，需提取到 Core：
- `SimpleRtsControllerSystem.HandleBoxSelection()` → 通用 AABB 空间查询
- `Physics2DPlaygroundPresentationSystem.SelectInAabb()` → 物理空间查询

提取为 `BoxSelectHelper` 工具类，接受 `ISpatialQueryService` 作为依赖。
