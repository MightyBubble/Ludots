---
文档类型: 架构设计
创建日期: 2026-02-06
最后更新: 2026-02-06
维护人: X28技术团队
文档版本: v4.0
适用范围: 06_交互层 - 14_表现层 - 渲染帧插值
状态: 已实现
依赖文档:
  - docs/03_基础服务/07_物理系统/03_定点数数学库架构.md
---

# 渲染帧插值系统 架构设计

# 1 设计概述

## 1.1 本文档定义

本文档定义渲染帧插值系统的架构设计，解决逻辑更新频率与渲染帧率不同步导致的视觉抖动问题。

边界：

- 逻辑层位置到表现层位置的插值
- 通用位置插值（物理、导航、网络等来源）

非目标：

- 不提供外推（Extrapolation）机制
- 不处理 Grid/Hex 坐标插值（它们是消费层）

## 1.2 设计目标

- 唯一真相：所有位置数据流经统一的 SSOT（WorldPositionCm）
- 平滑视觉：消除低频逻辑更新导致的视觉抖动
- 逻辑表现分离：插值只影响表现层，不影响逻辑裁决
- 0GC 热路径：插值系统在渲染帧执行，必须零分配
- 通用性：服务于所有位置来源（物理、导航、网络等）

## 1.3 设计思路

采用 SSOT 模式：所有位置来源同步到 WorldPositionCm，唯一的 WorldToVisualSyncSystem 负责插值到 VisualTransform。插值在定点数域进行，仅在最终输出时转换为浮点。

# 2 功能总览

## 2.1 术语表

| 术语 | 定义 |
|------|------|
| WorldPositionCm | 逻辑层位置 SSOT，定点数厘米 |
| PreviousWorldPositionCm | 上一帧位置，用于插值 |
| VisualTransform | 表现层位置，浮点米 |
| InterpolationAlpha | 插值因子 [0,1] |
| SSOT | Single Source of Truth，唯一真相源 |

## 2.2 功能导图

- 位置保存：SavePreviousWorldPositionSystem
- 物理同步：Physics2DToWorldPositionSyncSystem
- 插值计算：WorldToVisualSyncSystem
- 帧状态管理：PresentationFrameSetupSystem

## 2.3 架构图

```text
┌─────────────────────────────────────────────────────────┐
│                    源域 (Source Domain)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  Physics2D   │  │   NavAgent   │  │   Network    │   │
│  │  Position2D  │  │  TargetPos   │  │  SyncedPos   │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
└─────────┼─────────────────┼─────────────────┼───────────┘
          │    同步系统     │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────┐
│       逻辑层 SSOT: WorldPositionCm (Fix64Vec2 厘米)       │
│   WorldPositionCm        - 当前位置 (定点数)             │
│   PreviousWorldPositionCm - 上一帧位置 (定点数)          │
└─────────────────────────┬───────────────────────────────┘
                          │ WorldToVisualSyncSystem
                          ▼
┌─────────────────────────────────────────────────────────┐
│           表现层: VisualTransform (浮点米)                │
└─────────────────────────────────────────────────────────┘
```

## 2.4 关联依赖

上游依赖：

- `src/Core/Math/FixedPoint/` - Fix64Vec2
- `src/Core/Engine/Pacemaker/` - RealtimePacemaker

下游消费：

- DebugDraw 系统
- 渲染系统

# 3 业务设计

## 3.1 业务用例与边界

用例1：物理实体插值 - Physics2D 更新 Position2D，同步到 WorldPositionCm，插值到 VisualTransform
用例2：逻辑实体插值 - 非物理单位直接更新 WorldPositionCm，插值到 VisualTransform

边界：仅处理位置插值，不处理旋转/缩放插值。

## 3.2 业务主流程

```text
FixedUpdate 阶段：
1. SavePreviousWorldPositionSystem: Previous = Current
2. Physics2D / NavAgent / Network: 更新各自位置
3. Physics2DToWorldPositionSyncSystem: Position2D → WorldPositionCm

Render Frame 阶段：
1. PresentationFrameSetupSystem: 计算 InterpolationAlpha
2. WorldToVisualSyncSystem: Lerp(Previous, Current, alpha) → VisualTransform
3. DebugDraw / Rendering: 读取 VisualTransform
```

## 3.3 关键场景与异常分支

| 场景 | 处理方式 |
|------|----------|
| 插值禁用 | alpha = 1，直接使用当前位置 |
| 实体新创建 | Previous = Current，无跳变 |
| 实体被剔除 | 跳过插值（CullState.IsVisible = false） |

# 4 数据模型

## 4.1 概念模型

- WorldPositionCm：定点数厘米，逻辑层 SSOT
- PreviousWorldPositionCm：上一帧位置，插值起点
- VisualTransform：浮点米，表现层输出
- PresentationFrameState：全局单例，存储 InterpolationAlpha

## 4.2 数据结构与不变量

| 组件 | 字段 | 类型 | 不变量 |
|------|------|------|--------|
| WorldPositionCm | Value | Fix64Vec2 | 厘米单位 |
| PreviousWorldPositionCm | Value | Fix64Vec2 | 厘米单位 |
| VisualTransform | Position | Vector3 | 米单位，XZ平面 |
| PresentationFrameState | InterpolationAlpha | float | [0, 1] |

## 4.3 生命周期/状态机

```text
实体创建 → 设置 WorldPositionCm 和 PreviousWorldPositionCm 相等
         ↓
每 FixedUpdate → SavePreviousWorldPositionSystem 保存上一帧
              → 同步系统更新 WorldPositionCm
         ↓
每 RenderFrame → WorldToVisualSyncSystem 插值到 VisualTransform
```

# 5 落地方式

## 5.1 模块划分与职责

| 模块 | 职责 | 路径 |
|------|------|------|
| WorldPositionCm | 逻辑层位置 SSOT | `src/Core/Components/Components.cs` |
| PreviousWorldPositionCm | 插值用上一帧位置 | `src/Core/Components/Components.cs` |
| PresentationFrameState | 全局渲染帧状态 | `src/Core/Presentation/Components/InterpolationState.cs` |
| SavePreviousWorldPositionSystem | 保存上一帧位置 | `src/Core/Systems/SavePreviousWorldPositionSystem.cs` |
| Physics2DToWorldPositionSyncSystem | 物理→逻辑同步 | `src/Core/Ludots.Physics2D/Systems/Physics2DToWorldPositionSyncSystem.cs` |
| WorldToVisualSyncSystem | 统一插值系统 | `src/Core/Presentation/Systems/WorldToVisualSyncSystem.cs` |
| PresentationFrameSetupSystem | 计算插值因子 | `src/Core/Presentation/Systems/PresentationFrameSetupSystem.cs` |

## 5.2 关键接口与契约

同步契约：各来源系统在 FixedUpdate 阶段更新 WorldPositionCm
插值契约：WorldToVisualSyncSystem 在 RenderFrame 阶段读取 WorldPositionCm 和 PreviousWorldPositionCm

## 5.3 运行时关键路径与预算点

热路径：WorldToVisualSyncSystem 每渲染帧对所有可见实体执行插值

预算：1000 实体 × Lerp + 单位转换 < 0.5ms

# 6 与其他模块的职责切分

## 6.1 切分结论

| 模块 | 插值系统职责 | 其他模块职责 |
|------|--------------|--------------|
| Physics2D | 读取 Position2D | 写入 Position2D |
| Grid/Hex | 无 | 按需从 WorldPositionCm 转换 |
| DebugDraw | 读取 VisualTransform | 绘制 |

## 6.2 为什么如此

SSOT 原则：WorldPositionCm 是唯一真相，避免多处插值导致不一致。

## 6.3 影响范围

已废弃系统：

- Physics2DVisualSyncSystem - 已删除
- GridVisualSyncSystem - 已标记废弃

# 7 当前代码现状

## 7.1 现状入口

- 组件：`src/Core/Components/Components.cs`
- 表现状态：`src/Core/Presentation/Components/InterpolationState.cs`
- 系统：`src/Core/Systems/SavePreviousWorldPositionSystem.cs`
- 物理同步：`src/Core/Ludots.Physics2D/Systems/Physics2DToWorldPositionSyncSystem.cs`
- 插值系统：`src/Core/Presentation/Systems/WorldToVisualSyncSystem.cs`
- 帧设置：`src/Core/Presentation/Systems/PresentationFrameSetupSystem.cs`

## 7.2 差距清单

| 项目 | 状态 |
|------|------|
| WorldPositionCm 定点化 | 已实现 |
| SavePreviousWorldPositionSystem | 已实现 |
| Physics2DToWorldPositionSyncSystem | 已实现 |
| WorldToVisualSyncSystem | 已实现 |
| PresentationFrameSetupSystem | 已实现 |
| NavAgent 同步 | 未实现 |
| Network 同步 | 未实现 |

## 7.3 迁移策略与风险

风险：新增位置来源需编写对应同步系统
策略：提供模板，所有同步系统在 FixedUpdate 阶段写入 WorldPositionCm

# 8 验收条款

| 条款 | 验证方法 | 证据入口 |
|------|----------|----------|
| 15Hz 物理 + 60FPS 渲染时视觉平滑 | 启动 Physics2DPlaygroundMod 目视验证 | `src/Mods/Physics2DPlaygroundMod/` |
| 0GC：所有 Sync 系统每帧零分配 | Profiler 验证 | 待补充测试用例 |
| 统一数据流：所有来源 → WorldPositionCm → VisualTransform | 代码审查 | 本文档 §2.3 架构图 |
