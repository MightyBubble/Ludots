---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级逻辑 - 效用AI系统 - 效用AI（决策树与效用曲线）
状态: 草案
---

# 效用AI（决策树与效用曲线）架构设计

# 1 设计概述
## 1.1 本文档定义

本文档定义 Ludots 的效用AI（决策树与效用曲线评分）的总体架构与落地方式。目标是复用“配置驱动 + 烘焙只读数据 + 批处理评估”的结构，把决策结果统一映射为 GAS 的 Order（Order-first），并满足固定上界、确定性、零 GC 与 fail-fast 的裁决条款。

本文档不引入任何业务语义；所有可扩展语义必须通过 token/ID 注入（AttributeId/TagId/OrderTagId/BlackboardKeyId/CurveId）。

## 1.2 设计目标

1. 可预算：每个效用体（`UtilityAgent`）的目标候选固定上界为 16；每次决策的计算成本可静态估算。
2. 确定性：同一输入快照、同一配置、同一 tick，输出完全一致；tie-break 规则固定。
3. 零 GC：运行态不解析字符串、不分配可扩容集合、不产生逃逸引用。
4. 数据驱动：决策树结构、考量项、曲线、输入与归一化全部通过配置表达；运行态只读消费。
5. Order-first：决策输出统一为 Order 写入队列；后续执行闭合由 GAS 负责。

## 1.3 设计思路

- 把效用AI拆为三层：配置模型（可编辑）→ 加载期烘焙（只读数据/Blob）→ 运行态评估（批处理 Job/System）。
- 把“决策树”定义为决策器/状态机（`DecisionMaker`/StateMachine）：负责选择哪个决策（`Decision`）可被评估/执行、何时重评、何时中断，不让控制流散落在评分循环内。
- 把“效用曲线”收敛为响应曲线（`ResponseCurve`）：每个考量项（`Consideration`）将归一化输入映射为 0..1 分数，聚合方式固定且可预算。
- 把“目标选择”与“动作执行”切分：目标选择产出 Order，动作执行由 GAS 系统闭合。

# 2 功能总览
## 2.1 术语表

| 术语 | 定义 |
|---|---|
| 效用体（`UtilityAgent`） | 参与效用AI决策的实体 |
| 效用配置ID（`UtilityProfileId`） | 效用AI配置（`UtilityIntelligenceProfile`）的稳定 ID |
| 决策（`Decision`） | 一个可被选择并映射为 Order 的选项 |
| 考量项（`Consideration`） | 一个评分因子：归一化输入 → 响应曲线 → 分数(0..1) |
| 响应曲线（`ResponseCurve`） | 数值映射曲线（无业务语义） |
| 输入（`Input`） | 原始输入采样（Attribute/Blackboard/SpatialMetric 等） |
| 输入归一化（`InputNormalization`） | 把原始值映射到 0..1 |
| 目标过滤器（`TargetFilter`） | 基于 token/ID 的筛选与裁剪 |
| 决策器（`DecisionMaker`） | 决策树/状态机：控制决策评估与执行流 |
| 候选快照（`Snapshot16`） | 固定容量候选快照（Count: 0..16） |

## 2.2 功能导图

```
SpatialQuery -> Snapshot16
  -> TargetFilters (可选)

输入 -> 原始输入
  -> 输入归一化 -> 归一化输入 (0..1)

考量项：
  归一化输入 -> 响应曲线 -> 考量分数 (0..1)

决策：
  Weight × Π(考量分数) -> 决策分数
  -> tie-break/稳定选择 -> 最优决策(+目标)

决策器：
  控制何时评估/是否可中断
  -> Emit Order (Order-first)
```

## 2.3 架构图

```
┌───────────────────────────────┐
│ 配置层（可编辑）               │
│  - UtilityIntelligenceProfile  │
│  - ResponseCurve（响应曲线）     │
│  - ScoreProfile（可复用）       │
└──────────────┬────────────────┘
               │ 加载期烘焙（fail-fast）
               ▼
┌───────────────────────────────┐
│ 只读数据层（Blob/Registry）     │
│  - UtilityIntelligenceBlob     │
│  - Curves/Inputs/Decisions...  │
└──────────────┬────────────────┘
               │ 运行态批处理评估（预算/确定性/零GC）
               ▼
┌───────────────────────────────┐
│ UtilityMakeDecisionsSystem/Job │
│  - Targets/Inputs/Normalize    │
│  - Considerations/Decisions    │
│  - DecisionMaker/StateMachine  │
└──────────────┬────────────────┘
               │ Order（真源）
               ▼
┌───────────────────────────────┐
│ GAS（执行闭合，SSOT）           │
│  - OrderQueue/Dispatch/Tasks   │
└───────────────────────────────┘
```

## 2.4 关联依赖

- 空间服务：`docs/03_基础服务/06_空间服务/03_空间查询接口.md`
- 效用AI接口规范：
  - `docs/05_高级逻辑/12_效用AI系统/02_接口规范/01_索敌查询.md`
  - `docs/05_高级逻辑/12_效用AI系统/02_接口规范/02_空间查询适配层.md`
- GAS 统一规范：`docs/04_游戏逻辑/08_能力系统/02_统一规范/00_总览.md`
- Order 真源：`src/Core/Gameplay/GAS/Orders/OrderQueue.cs`

# 3 业务设计
## 3.1 业务用例与边界

用例（抽象，不含业务字眼）：

- 对一个 UtilityAgent，在给定 Snapshot16、配置与预算的前提下，选择一个 Decision（可带 target）并产出一条 Order。

边界：

- 本模块不负责空间候选生成（由 SpatialQuery 适配层负责）。
- 本模块不负责能力/效果执行（由 GAS 负责）。

## 3.2 业务主流程

```
Tick/Step:
  1) SpatialQuery -> Snapshot16 (Count<=16)
  2) UtilityMakeDecisions:
       - Inputs/Normalize
       - Considerations -> scores
       - Decisions -> best
       - DecisionMaker -> allowed decision & interrupt
  3) Emit Order -> OrderQueue
```

## 3.3 关键场景与异常分支

- 候选为空：允许返回“无决策/不产出 Order”，并记录可观测计数。
- 配置非法：加载期强校验 fail-fast，禁止运行态隐式兼容。
- 预算超限：熔断并返回“无决策”，并记录原因；不得产出部分不一致结果。

# 4 数据模型
## 4.1 概念模型

- UtilityIntelligenceProfile：描述 decisions/considerations/inputs/normalizations/curves 的配置集合。
- UtilityIntelligenceBlob：加载期烘焙的只读数据集合，运行态以索引访问。
- Decision：关联若干 considerationIndex，并绑定输出的 OrderTagId 与参数映射。
- Consideration：关联 inputNormalizationIndex 与 curveId，提供 `score(0..1)`。
- ResponseCurve：提供 `Evaluate(x in 0..1) -> y in 0..1`。

## 4.2 数据结构与不变量

- Snapshot16 的 Count 永远不超过 16。
- 所有数组均以索引引用，不允许运行态字符串查表。
- Decision 的聚合必须在数值域内闭合（0..1 或明确的 clamp 规则）。
- tie-break 必须固定：推荐 `FinalScore` → `StableKey` → `EntityId`。

## 4.3 生命周期/状态机

- UtilityIntelligenceState（建议）：记录上一次决策与 target，用于稳定性与允许的中断规则。
- DecisionMaker 负责决定“是否允许切换决策/是否允许切换 target”，避免评分层写控制流。

# 5 落地方式
## 5.1 模块划分与职责

- 配置/烘焙：
  - UtilityIntelligenceProfile/ResponseCurve：数据源
  - Registry/BlobBuilder：加载期解析、强校验、烘焙只读数据
- 运行态评估：
  - UtilityMakeDecisionsSystem/Job：批处理评估并产出 DecisionResult
  - UtilityExecuteDecisionsSystem：把 DecisionResult 映射为 Order 并入队

## 5.2 关键接口与契约

- 配置结构：
  - `docs/05_高级逻辑/12_效用AI系统/03_配置结构/02_效用AI配置_配置结构.md`
  - `docs/05_高级逻辑/12_效用AI系统/03_配置结构/03_响应曲线_配置结构.md`
- 目标候选与空间输入：
  - `docs/05_高级逻辑/12_效用AI系统/02_接口规范/02_空间查询适配层.md`
- 裁决输出：
  - `src/Core/Gameplay/GAS/Orders/OrderQueue.cs`

## 5.3 运行时关键路径与预算点

- 每 agent 的 target 集合上限固定 16。
- 每 tick 的评估成本上界：
  - `Targets(<=16) × ConsiderationsWithTargets + ConsiderationsNoTargets + Decisions`
  - 每个曲线求值必须为 O(1)。
- 任何需要 map 的地方必须以固定容量结构或两段式数组实现，禁止运行态哈希映射扩容。

# 6 与其他模块的职责切分
## 6.1 切分结论

- 空间筛选：空间服务负责；UtilityIntelligence 只读消费 Snapshot16。
- 空间筛选：空间服务负责；效用AI只读消费 Snapshot16。
- 决策评估：效用AI负责；输出结果统一映射为 Order。
- 执行闭合：GAS 负责；效用AI不直接操作能力/效果。

## 6.2 为什么如此

- 固定上界 + 批处理评估使大规模群体成本可预测。
- Order-first 明确真源，避免“缓存当真源”的分歧路径。
- 配置烘焙隔离编辑期与运行期，保证零 GC 与 fail-fast。

## 6.3 影响范围

- 任何需要“决策树 + 效用曲线评分”的系统必须通过效用AI配置（`UtilityIntelligenceProfile`）表达，不允许旁路引入字符串规则或运行态动态图结构。

# 7 当前代码现状
## 7.1 现状入口

- Order 真源：`src/Core/Gameplay/GAS/Orders/OrderQueue.cs`
- 黑板组件（供输入采样使用）：`src/Core/Gameplay/GAS/Components/BlackboardIntBuffer.cs`、`src/Core/Gameplay/GAS/Components/BlackboardFloatBuffer.cs`

## 7.2 差距清单

- 缺少效用AI配置（`UtilityIntelligenceProfile`）与响应曲线（`ResponseCurve`）的加载期解析与强校验实现。
- 缺少 UtilityIntelligenceBlob 的烘焙与注册表。
- 缺少 UtilityMakeDecisionsSystem/Job 与 UtilityExecuteDecisionsSystem 的运行时代码。

## 7.3 迁移策略与风险

- 先落地配置与加载期 fail-fast，再落地运行时评估系统；避免先写评分循环再补边界导致返工。
- 关键风险：稳定键来源、目标集合裁剪策略、决策中断规则需先裁决再实现。

# 8 验收条款

1. 固定上界：任何一次决策评估的 target Count 永远不超过 16，可通过统计验证。
2. 确定性：同一输入快照与同一配置，重复执行得到完全一致的 best decision/target，可通过回放用例验证。
3. 零 GC：运行态无字符串解析与集合扩容，可通过分配追踪验证。
4. fail-fast：配置引用不存在/超上限时加载期直接失败，并给出可定位错误信息（文件路径 + 字段路径），可通过构造非法配置验证。
