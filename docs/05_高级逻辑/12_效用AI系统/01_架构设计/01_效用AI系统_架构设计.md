---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级逻辑 - 效用AI系统 - 架构设计
状态: 草案
---

# 效用AI系统 架构设计

# 1 设计概述
## 1.1 本文档定义

本文档定义 Ludots 效用AI系统的总体架构：面向大规模群体的“索敌/目标选择”如何在确定性与预算约束下运行，并以 Order-first 的方式与 GAS、空间服务对齐。

本文档不定义任何业务语义；所有扩展语义必须通过 token/ID 注入（TagId/AttributeId/OrderTagId/BlackboardKeyId）。

## 1.2 设计目标

1. 固定上界：核心热路径以候选上限 16 为硬约束，保证成本可预测。
2. 确定性：排序与采样有稳定键与固定 tie-break；同输入同输出。
3. 零 GC：运行态不解析字符串、不使用可扩容集合、不产生逃逸引用。
4. 松耦合：空间输入通过适配层接口获取；行为系统不绑定 AOI/物理/导航实现。
5. Order-first：裁决输出以 Order 为真源；后续执行由 GAS 承担。

## 1.3 设计思路

- 将“目标选择”收敛为 Query 风格的阶段化执行：Collect（候选）→ Refine/Score（过滤/打分）→ Aggregate（稳定选择）。
- 把空间计算与决策计算切分：空间服务提供快照，效用AI只读消费并产出 Order。
- 预算与失败策略前置到加载期与接口契约：配置强校验 fail-fast，运行态超限熔断可观测。

# 2 功能总览
## 2.1 术语表

| 术语 | 定义 |
|---|---|
| TargetingQuery | 索敌查询；消费候选快照并产出 Order |
| SpatialQuery | 空间查询适配层；产出候选快照（固定 16） |
| ScoreProfile | 评分配置；定义通道化打分与聚合方式 |
| StableKey | 稳定键；排序/tie-break/随机派生的确定性输入 |
| Order-first | Order 是裁决真源；Blackboard 只做上下文交换 |

## 2.2 功能导图

```
SpatialQuery（空间输入）
  CollectCandidates -> Snapshot16

TargetingQuery（目标选择）
  Consume Snapshot16
    -> Refine（gate/裁剪）
    -> Score（ScoreProfile）
    -> Aggregate（稳定选择）
  Emit Order（真源）
```

## 2.3 架构图

```
┌───────────────────────────────┐
│ 空间服务（SSOT）               │
│  - 空间索引/AOI/物理/导航      │
│  - 提供 SpatialQuery 接口口径  │
└──────────────┬────────────────┘
               │ Snapshot16（Count<=16）
               ▼
┌───────────────────────────────┐
│ 效用AI系统（本目录）            │
│  - TargetingQuery（接口契约）  │
│  - ScoreProfile（配置结构）    │
│  - 预算/确定性/失败策略         │
└──────────────┬────────────────┘
               │ Order（真源）
               ▼
┌───────────────────────────────┐
│ 能力系统 GAS（SSOT）            │
│  - OrderQueue/Dispatch          │
│  - Ability/Effect 执行与闭合     │
└───────────────────────────────┘
```

## 2.4 关联依赖

- 空间服务：`docs/03_基础服务/06_空间服务/00_总览.md`
- 空间查询接口：`docs/03_基础服务/06_空间服务/03_空间查询接口.md`
- GAS 统一规范：`docs/04_游戏逻辑/08_能力系统/02_统一规范/00_总览.md`
- 执行时序与 Clock：`docs/04_游戏逻辑/08_能力系统/02_统一规范/01_GAS_设计总览.md`

# 3 业务设计
## 3.1 业务用例与边界

用例（抽象，不含业务字眼）：

- 对一个 actor，在给定候选上限与预算下，选择一个或多个目标并产出 Order。

边界：

- 不做“空间候选生成”的具体实现细节（由空间服务负责）。
- 不做“执行行为”的具体实现细节（由 GAS 消费 Order 负责）。

## 3.2 业务主流程

```
Tick/Step 开始
  -> SpatialQuery.CollectCandidates(actor, params, budget) => Snapshot16
  -> TargetingQuery.Execute(actor, profileId, Snapshot16) => Order?
  -> OrderQueue 入队
Tick/Step 结束
```

## 3.3 关键场景与异常分支

- 候选为空：不产出 Order（返回 false），且可观测计数。
- 预算超限：熔断并返回 false；不得产出部分不一致结果。
- 配置非法：加载期强校验 fail-fast；运行态不允许静默 fallback。

# 4 数据模型
## 4.1 概念模型

- `Snapshot16`：空间候选快照（EntityId + StableKey + SpatialMetrics）
- `ScoreProfile`：评分配置（channels + aggregate）
- `Order`：裁决输出（Actor/Target/Args/OrderTagId）

## 4.2 数据结构与不变量

- 候选数量 `Count` 必须满足 `0 <= Count <= 16`。
- 评分通道数量必须在加载期上限内，并在运行态保持 O(1) 计算。
- StableKey 与 tie-break 规则必须固定，不得依赖遍历顺序。

## 4.3 生命周期/状态机

- Snapshot16 生命周期：生成于一个 tick/step 的空间阶段，消费于同一 tick/step 的行为阶段，不跨越未声明的缓存策略。
- Order 生命周期：入队后成为裁决真源，后续执行由 GAS 负责闭合。

# 5 落地方式
## 5.1 模块划分与职责

- `SpatialQuery`：空间侧接口与快照生成（SSOT 在空间服务目录）。
- `TargetingQuery`：行为侧接口与失败策略，消费快照并产出 Order。
- `ScoreProfile`：配置结构与加载期强校验，运行态只读消费。

## 5.2 关键接口与契约

- 索敌查询（TargetingQuery）：`docs/05_高级逻辑/12_效用AI系统/02_接口规范/01_索敌查询.md`
- 空间查询适配层（SpatialQuery）：`docs/05_高级逻辑/12_效用AI系统/02_接口规范/02_空间查询适配层.md`
- 评分配置（ScoreProfile）：`docs/05_高级逻辑/12_效用AI系统/03_配置结构/01_评分规范.md`

## 5.3 运行时关键路径与预算点

- 每个 actor 的候选上限固定 16。
- 评分成本上界：`Count(<=16) × ChannelCount(加载期上限)`。
- 排序/tie-break 固定规则；需要随机时必须由 StableKey 派生。

# 6 与其他模块的职责切分
## 6.1 切分结论

- 空间候选与空间标量：空间服务负责，效用AI只读消费。
- 裁决输出与执行闭合：效用AI只产出 Order；执行闭合由 GAS 负责。

## 6.2 为什么如此

- 让热路径可预算化：候选固定上界 + 通道固定上界。
- 让实现可迁移：空间实现与行为实现分离，跨引擎复用成本低。
- 让真源明确：Order-first 避免“缓存当真源”导致的分歧。

## 6.3 影响范围

- 任何需要“目标选择”的系统必须通过 TargetingQuery + ScoreProfile 接口/配置，禁止旁路实现私有规则。

# 7 当前代码现状
## 7.1 现状入口

- 效用AI系统运行时代码尚未落地；本文档用于约束后续实现。
- Order 真源：`src/Core/Gameplay/GAS/Orders/OrderQueue.cs`

## 7.2 差距清单

- 缺少 TargetingQuery/ScoreProfile 的运行时注册表与加载期强校验实现。
- 缺少 SpatialQuery 的行为侧消费适配与预算指标上报。

## 7.3 迁移策略与风险

- 先落地接口与加载期强校验（fail-fast），再落地运行时系统；避免先写热路径再补约束导致返工。
- 风险点：稳定键来源、预算指标口径、跨 tick 缓存策略必须先裁决再实现。

# 8 验收条款

1. 候选上限：任何一次目标选择的候选 Count 永远不超过 16，可通过日志/统计验证。
2. 确定性：同一输入快照与同一配置，重复执行得到完全一致的选择结果，可通过回放用例验证。
3. fail-fast：配置引用非法/超上限时，加载期强校验直接失败并给出可定位错误信息，可通过构造非法配置验证。
