---
文档类型: 配置结构
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级逻辑 - 效用AI系统 - 配置结构 - 评分配置
状态: 草案
---

# 评分配置（ScoreProfile）配置结构

# 1 概述
## 1.1 本文档定义

本文档定义效用AI系统中 ScoreProfile（评分配置）的结构、字段含义、加载期强校验与版本策略。ScoreProfile 用于将候选实体映射为单一标量 `score`，供索敌查询（TargetingQuery）做稳定选择。

本文档不引入任何业务语义，不允许出现业务字眼；配置只能引用 token/ID（AttributeId/TagId/SpatialMetricId/CurveId/OrderTagId/BlackboardKeyId），禁止 magic string。

## 1.2 使用场景与边界

使用场景：

- 为 UGC 提供可扩展的“输入→曲线→权重→聚合”评分通道组合。
- 在固定候选上界（16）内，对每个候选做 O(通道数) 的可预算化评分。

边界：

- ScoreProfile 不负责空间候选生成（由 SpatialQuery 适配层提供）。
- ScoreProfile 不直接触发技能/效果；裁决输出仍以 Order 为真源。

## 1.3 关联运行时消费点

- `docs/05_高级逻辑/12_效用AI系统/02_接口规范/01_索敌查询.md`（索敌查询消费评分结果）
- `src/Core/Gameplay/GAS/Orders/OrderQueue.cs`（裁决输出真源）

# 2 文件位置与命名
## 2.1 目录位置

裁决（草案口径）：ScoreProfile 的配置资产应放在 Mod/VFS 可发现的配置目录中，并由加载期注册表统一索引。

推荐路径（待与 Mod/VFS 目录规范对齐后固化）：

- `Content/Behavior/ScoreProfiles/`

## 2.2 命名规则

- 文件名：`{ScoreProfileId}.json`
- ScoreProfileId 必须是稳定 ID（不依赖显示名），用于引用与存档一致性。

## 2.3 发现与加载机制

- 加载期扫描配置目录，建立 `ScoreProfileRegistry`（ID → 结构化配置）。
- 加载期完成所有 token/ID 解析与强校验；运行态只读消费，不允许动态解析字符串。

# 3 完整示例
## 3.1 最小可用示例

```json
{
  "version": 1,
  "id": 1001,
  "channels": [
    {
      "inputType": "Attribute",
      "inputId": 2001,
      "curveId": 3001,
      "weight": 1.0,
      "gateAll": [],
      "gateAny": [],
      "blockAny": []
    }
  ],
  "aggregate": "SumClamp01"
}
```

## 3.2 常见变体

- 多通道加权求和：多个 channels，权重不同。
- gate 修正：通过 gateAll/gateAny/blockAny 控制通道是否参与。
- 空间标量输入：inputType=SpatialMetric，inputId 指向 SpatialMetricId。

# 4 字段说明

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| version | int | 是 | - | 配置版本号（见 §6） |
| id | int | 是 | - | ScoreProfileId（稳定 ID） |
| channels | array | 是 | - | 评分通道列表（通道数受上限约束） |
| aggregate | string(enum) | 是 | - | 聚合方式（受枚举约束；见 §5） |

Channel 字段：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| inputType | string(enum) | 是 | - | 输入类型：Attribute / SpatialMetric |
| inputId | int | 是 | - | 对应 AttributeId 或 SpatialMetricId |
| curveId | int | 是 | - | CurveId（影响函数参数集合） |
| weight | float | 是 | 1.0 | 权重（数值域由运行时约束） |
| gateAll | int[] | 否 | [] | 需要全部满足的 TagId 列表 |
| gateAny | int[] | 否 | [] | 满足任一即可的 TagId 列表 |
| blockAny | int[] | 否 | [] | 命中任一则阻断的 TagId 列表 |

# 5 校验规则
## 5.1 加载期强校验

必须 fail-fast：

- version/id 缺失或非法（非正数/重复）
- channels 为空或超过上限（建议上限 16；必须在加载期裁决并写死）
- inputType 不在枚举内
- inputId/curveId 引用不存在（Registry 无法解析）
- aggregate 不在枚举内

## 5.2 错误信息与诊断

错误信息必须包含：

- 配置文件相对路径
- ScoreProfileId
- 失败字段路径（例如 `channels[3].inputId`）
- 失败原因（枚举非法/引用不存在/超上限）

# 6 版本兼容性
## 6.1 版本号策略

- `version` 为整数递增。
- 同一 major（当前仅 version）内，不允许静默兼容旧字段名；破坏性变更必须提升 version。

## 6.2 破坏性变更与迁移方式

- 破坏性变更必须提供离线迁移工具或加载期显式迁移步骤，并在迁移失败时 fail-fast。
- 运行态不得悄悄接受旧格式或进行隐式 fallback。
