---
文档类型: 配置结构
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级逻辑 - 效用AI系统 - 配置结构 - 效用AI配置
状态: 草案
---

# 效用AI配置（UtilityIntelligenceProfile）配置结构

# 1 概述
## 1.1 本文档定义

本文档定义效用AI配置（`UtilityIntelligenceProfile`，决策树与效用曲线评分）的配置结构、加载期强校验、失败策略与版本策略。该配置用于描述：

- 输入（`Input`）与输入归一化（`InputNormalization`）
- 考量项（`Consideration`）：归一化输入 → 响应曲线（`ResponseCurve`）→ 分数(0..1)
- 决策（`Decision`）：由多个考量项聚合得到分数，并映射为 Order
- 决策控制（决策器/状态机，`DecisionMaker`/StateMachine）：控制何时评估/何时允许中断

本文档不引入任何业务语义；所有扩展语义只能通过 token/ID 注入（AttributeId/TagId/OrderTagId/BlackboardKeyId/CurveId）。

## 1.2 使用场景与边界

使用场景：

- 为 UGC/Mod 提供可编辑的决策树与效用曲线评分结构。
- 在固定候选上界（16）与固定配置上界内，批处理评估并产出 Order。

边界：

- 不定义空间候选生成（由 SpatialQuery 适配层负责）。
- 不定义能力/效果执行（由 GAS 消费 Order 负责闭合）。

## 1.3 关联运行时消费点

- `docs/05_高级逻辑/12_效用AI系统/01_架构设计/02_效用AI_架构设计.md`
- Order 真源：`src/Core/Gameplay/GAS/Orders/OrderQueue.cs`

# 2 文件位置与命名
## 2.1 目录位置

推荐路径（待与 Mod/VFS 目录规范对齐后固化）：

- `Content/Behavior/Utility/Profiles/`

## 2.2 命名规则

- 文件名：`{UtilityProfileId}.json`
- UtilityProfileId 必须是稳定 ID（不依赖显示名），用于引用与存档一致性。

## 2.3 发现与加载机制

- 加载期扫描配置目录，建立 `UtilityIntelligenceRegistry`（UtilityProfileId → 结构化配置）。
- 加载期完成所有 token/ID 解析与强校验，并烘焙为只读数据（Blob/表）；运行态只读消费。

# 3 完整示例
## 3.1 最小可用示例

```json
{
  "version": 1,
  "id": 9001,
  "inputs": [
    { "id": 1, "source": "BlackboardFloat", "keyId": 1001 }
  ],
  "normalizations": [
    { "id": 1, "kind": "InRange", "inputId": 1, "min": 0.0, "max": 1.0 }
  ],
  "considerations": [
    { "id": 1, "normalizationId": 1, "curveId": 3001 }
  ],
  "decisions": [
    {
      "id": 1,
      "weight": 1.0,
      "considerationIds": [1],
      "targetMode": "SingleFromSnapshot16",
      "order": { "orderTagId": 2001 }
    }
  ],
  "decisionMaker": { "kind": "StatelessMaxScore" }
}
```

## 3.2 常见变体

- 多决策：多个 decisions，分别绑定不同的 orderTagId。
- 有 target/无 target 混合：部分 decision 不依赖目标集合（targetMode=None）。
- 决策树/状态机：decisionMaker 从 Stateless 扩展为有状态（记录上次决策、允许中断规则）。

# 4 字段说明

顶层字段：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| version | int | 是 | - | 配置版本号（见 §6） |
| id | int | 是 | - | UtilityProfileId（稳定 ID） |
| inputs | array | 是 | - | 输入定义列表（数量受上限约束） |
| normalizations | array | 否 | [] | 归一化定义列表（数量受上限约束） |
| considerations | array | 是 | - | 考量项列表（数量受上限约束） |
| decisions | array | 是 | - | 决策列表（数量受上限约束） |
| decisionMaker | object | 是 | - | 决策控制器（状态机/树） |

输入（`Input`）字段：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| id | int | 是 | - | InputId（本配置内唯一） |
| source | string(enum) | 是 | - | 输入来源（受枚举约束） |
| keyId | int | 视 source | - | BlackboardKeyId（若 source 为 Blackboard*） |
| attributeId | int | 视 source | - | AttributeId（若 source 为 Attribute） |
| spatialMetricId | int | 视 source | - | SpatialMetricId（若 source 为 SpatialMetric） |

输入归一化（`InputNormalization`）字段：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| id | int | 是 | - | NormalizationId（本配置内唯一） |
| kind | string(enum) | 是 | - | 归一化类型（受枚举约束） |
| inputId | int | 是 | - | 绑定到 InputId |
| min/max | float | 视 kind | - | InRange 等类型使用 |

考量项（`Consideration`）字段：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| id | int | 是 | - | ConsiderationId（本配置内唯一） |
| normalizationId | int | 否 | -1 | 绑定到 NormalizationId；无则输入视为 0 |
| curveId | int | 是 | - | CurveId（见 ResponseCurve 配置） |

决策（`Decision`）字段：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| id | int | 是 | - | DecisionId（本配置内唯一） |
| weight | float | 是 | 1.0 | 决策权重（数值域由运行时约束） |
| considerationIds | int[] | 是 | - | 该决策依赖的 considerations |
| targetMode | string(enum) | 是 | - | 目标模式（None/SingleFromSnapshot16/TopKFromSnapshot16 等） |
| order | object | 是 | - | Order 映射（见下） |

Order 映射字段（最小集合）：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| orderTagId | int | 是 | - | OrderTagId（禁止字符串） |

决策器（`DecisionMaker`）字段（最小集合）：

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|---|---|---:|---|---|
| kind | string(enum) | 是 | - | 决策控制器类型（受枚举约束） |

# 5 校验规则
## 5.1 加载期强校验

必须 fail-fast：

- version/id 缺失或非法（非正数/重复）
- inputs/considerations/decisions 为空或超过上限（上限必须加载期裁决并写死）
- 枚举字段非法（source/kind/targetMode/decisionMaker.kind）
- 引用非法：
  - normalizationId 不存在
  - curveId 在 CurveRegistry 中不存在
  - considerationIds 引用不存在
  - inputId 引用不存在
- 决策输出非法：
  - orderTagId 缺失或非法
- 目标模式与预算不一致：
  - targetMode 依赖 Snapshot16 时，必须声明候选上限=16 且 tie-break 固定

## 5.2 错误信息与诊断

错误信息必须包含：

- 配置文件相对路径
- UtilityProfileId
- 失败字段路径（例如 `decisions[2].considerationIds[1]`）
- 失败原因（枚举非法/引用不存在/超上限/缺失字段）

# 6 版本兼容性
## 6.1 版本号策略

- `version` 为整数递增。
- 不允许静默兼容旧字段名；破坏性变更必须提升 version。

## 6.2 破坏性变更与迁移方式

- 破坏性变更必须提供离线迁移工具或加载期显式迁移步骤，并在迁移失败时 fail-fast。
- 运行态不得悄悄接受旧格式或进行隐式 fallback。
