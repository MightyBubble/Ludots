---
文档类型: 接口规范
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级逻辑 - 效用AI系统 - 接口规范 - 空间查询适配层
状态: 草案
---

# 空间查询适配层（SpatialQuery）接口规范

# 1 概述
## 1.1 本文档定义

本文档定义效用AI系统对“空间输入”的唯一依赖口径：空间查询适配层（SpatialQuery）接口。其目标是让索敌/目标选择逻辑不绑定 AOI、物理、导航网或具体引擎，实现跨引擎复用与可预算化执行。

SpatialQuery 只负责提供候选实体与空间标量快照，不承载任何业务语义，不允许出现业务字眼；所有过滤语义必须通过 token/ID 注入。

## 1.2 术语与约定

| 术语 | 说明 |
|---|---|
| 空间查询（`SpatialQuery`） | 空间查询；生成候选快照 |
| 候选快照（`Snapshot16`） | 固定容量候选快照；Count: 0..16 |
| 空间标量（`SpatialMetric`） | 空间标量（距离/夹角/可见性等）；均为数值，不含引擎对象 |
| 预算（`Budget`） | 预算；用于限制内部遍历与计算 |

## 1.3 关键约束

- 输出固定上界：候选快照 Count 最高 16。
- 输出必须是纯值类型快照：不得携带引擎对象指针、不得携带引用类型。
- 确定性：若需要排序/裁剪，必须使用稳定键与固定 tie-break。
- 频率：必须由离散 Clock 域驱动，支持回合制手动 step。

# 2 核心接口
## 2.1 SpatialQuery.CollectCandidates
### 签名

伪签名（概念口径，非代码 API）：

`CollectCandidates(origin, queryParams, budget, out snapshot16)`

### 参数说明

| 参数名 | 类型 | 单位/取值范围 | 说明 |
|---|---|---|---|
| origin | EntityId | - | 发起者实体 |
| queryParams | struct | - | 查询参数（中心/半径/过滤 token 等） |
| budget | struct | - | 预算（最大访问节点数/最大计算量等） |
| snapshot16 | Snapshot16(out) | Count: 0..16 | 候选快照（含 StableKey 与空间标量） |

### 返回值

- 成功：返回 true 且产出 Snapshot16
- 失败：返回 false（例如参数非法、预算熔断）

### 异常/错误码

- 加载期强校验失败：必须 fail-fast（拒绝进入运行态）
- 运行态失败：必须返回失败且可观测原因（统计/日志开关由框架统一控制）

### 线程安全性

- 接口必须能在 simulation 侧被并行消费；输出为只读快照。
- 禁止在接口内部产生可逃逸引用或共享可变集合。

# 3 使用约束
## 3.1 生命周期与所有权

- Snapshot16 的所有权归 SpatialQuery 实现或其分配器；调用方只读消费，且不得跨 tick 持有不再有效的句柄。
- 若 Snapshot16 需要缓存，必须以“tick + origin + params”作为缓存键，并显式声明失效策略。

## 3.2 容量与预算

- 返回容量上限固定 16。
- 实现必须提供可观测的预算消耗指标（visited、dropped、early-exit reason）。

## 3.3 失败策略

- 参数非法：加载期强校验 fail-fast；运行态返回 false 并记录诊断信息。
- 预算超限：熔断并返回 false；不得部分写入不一致快照。

# 4 代码入口
## 4.1 接口定义位置

- 空间服务目录已有接口口径（效用AI系统应依赖该口径，而不是自定义并行口径）：
  - `docs/03_基础服务/06_空间服务/03_空间查询接口.md`

## 4.2 关键实现位置

- 效用AI系统对接点（索敌查询消费快照）：
  - `docs/05_高级逻辑/12_效用AI系统/02_接口规范/01_索敌查询.md`

## 4.3 相关测试与对齐文档

- `docs/04_游戏逻辑/08_能力系统/02_统一规范/00_总览.md`
- `docs/04_游戏逻辑/08_能力系统/02_统一规范/01_GAS_设计总览.md`
