---
文档类型: 接口规范
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 高级逻辑 - 效用AI系统 - 接口规范 - 索敌查询
状态: 草案
---

# 索敌查询（TargetingQuery）接口规范

# 1 概述
## 1.1 本文档定义

本文档定义“索敌查询（TargetingQuery）”的接口契约与使用约束。TargetingQuery 用于在确定性与预算约束下完成“候选收集 → 过滤/打分 → 稳定选择”，并将裁决结果统一输出为 Order（Order-first）。

本文档不引入任何业务语义，不允许出现业务字眼；所有可扩展语义必须通过 token/ID 注入（AttributeId/TagId/OrderTagId/BlackboardKeyId）。

## 1.2 术语与约定

| 术语 | 说明 |
|---|---|
| 候选（`Candidate`） | 候选实体；固定上限为 16 |
| 稳定键（`StableKey`） | 稳定键；用于排序与 tie-break |
| 配置ID（`ProfileId`） | TargetingProfile 的配置 ID；加载期确定 |
| Order-first | 裁决输出以 Order 为真源；Blackboard 仅用于上下文交换/缓存 |

## 1.3 关键约束

- 候选上限固定 16，且必须可审计 dropped/熔断原因。
- 运行态零 GC：禁止字符串解析、禁止托管集合飞线、禁止运行态反射。
- 确定性：排序/采样必须依赖 StableKey 与固定 tie-break，不依赖遍历顺序。
- 频率由离散 Clock 域驱动，支持回合制手动 step；不允许秒级 dt 参与裁决。

# 2 核心接口
## 2.1 TargetingQuery.Execute
### 签名

伪签名（概念口径，非代码 API）：

`Execute(actor, profileId, spatialCandidatesSnapshot16, out order)`

### 参数说明

| 参数名 | 类型 | 单位/取值范围 | 说明 |
|---|---|---|---|
| actor | EntityId | - | 发起者实体 |
| profileId | int | >=0 | 加载期确定的配置 ID |
| spatialCandidatesSnapshot16 | Candidate[16] + Count | Count: 0..16 | 空间侧提供的候选快照（只读） |
| order | Order(out) | - | 裁决输出；统一写入 OrderQueue |

### 返回值

- 成功：返回 true 且产出 Order
- 失败：返回 false（例如候选为空、预算熔断、配置非法）

### 异常/错误码

- 加载期强校验失败：必须 fail-fast（拒绝进入运行态）
- 运行态失败：必须返回失败且可观测原因（统计/日志开关由框架统一控制）

### 线程安全性

- Execute 必须是纯计算：仅读取快照与只读表，写入本实体输出（Order）或本实体缓存（Blackboard）。
- 禁止写共享结构（全局索引/队列以外的共享容器）；结构变更必须在允许 Phase 通过回放机制完成。

# 3 使用约束
## 3.1 生命周期与所有权

- 候选快照由空间查询适配层生成；TargetingQuery 只读消费，不拥有其内存。
- Order 为裁决真源：一旦入队，后续系统以 Order 为准；Blackboard 仅可作为缓存与上下文交换。

## 3.2 容量与预算

- 候选容量固定 16。
- 通道化评分（若存在）必须有通道数上限；通道数 × 候选数必须在预算内。
- 超限必须熔断并可观测（dropped、early-exit reason）。

## 3.3 失败策略

- 候选为空：不产出 Order（返回 false）。
- 配置非法：加载期强校验 fail-fast；运行态不得静默 fallback。
- 预算超限：熔断并返回 false；不得部分写入/不一致写入。

# 4 代码入口
## 4.1 接口定义位置

- `docs/05_高级逻辑/12_效用AI系统/02_接口规范/01_索敌查询.md`

## 4.2 关键实现位置

- 效用AI系统运行时代码尚未落地；本接口规范用于约束后续实现的行为边界与失败策略。
- 作为裁决输出真源的 Order：
  - `src/Core/Gameplay/GAS/Orders/OrderQueue.cs`
  - `src/Core/Gameplay/GAS/Orders/OrderArgs.cs`

## 4.3 相关测试与对齐文档

- `docs/04_游戏逻辑/08_能力系统/02_统一规范/00_总览.md`
- `docs/04_游戏逻辑/08_能力系统/02_统一规范/01_GAS_设计总览.md`
- `docs/03_基础服务/06_空间服务/03_空间查询接口.md`
- `docs/05_高级逻辑/12_效用AI系统/02_接口规范/02_空间查询适配层.md`
