---
文档类型: 接口规范
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 04_游戏逻辑 - 导航寻路 - 核心接口
状态: 草案
---

# 导航寻路 接口规范

# 1 概述

## 1.1 本文档定义

本文档定义 Navigation/Pathfinding 对外提供的核心接口集合，用于上层系统（AI/GAS/GraphRuntime）以统一方式提交请求、轮询结果、读取路径数据，并保证容量、预算与失败策略一致。

## 1.2 术语与约定

- “接口”既可对应具体 C# 接口/类，也可对应系统级服务对象（system-owned resource）。
- 所有输入输出必须 ID 化、可序列化、可确定性；禁止 `string` 与托管集合参与运行时裁决。
- 坐标单位：内部真源为厘米（cm）。

## 1.3 关键约束

- 固定容量：RequestQueue/ResultQueue 必须固定容量；溢出必须丢弃并计数，不允许扩容。
- 预算化：每条请求必须携带预算（maxExpanded/corridor 上限等），超限必须返回明确错误码。
- 句柄化：路径本体只存在于 PathStore；实体与业务系统只持有 PathHandle（Index+Generation）。
- 无静默 fallback：禁止为历史调用方式保留静默兼容分支；迁移必须显式失败策略。

# 2 核心接口

## 2.1 IPathService（提交与轮询）

### 签名

伪代码签名：

```csharp
bool TryEnqueue(in PathRequest request, out PathEnqueueError error);
int  PumpSolve(int maxRequestsThisTick);
int  PumpApplyResults(int maxResultsThisTick);
bool TryDequeueResult(out PathResult result);
```

### 参数说明

`TryEnqueue`：

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| request | PathRequest | 见 02 文档 | 路径请求（包含预算、版本快照、稳定排序字段） |
| error | PathEnqueueError(out) | enum | 队列满/参数非法/版本不匹配等原因 |

`PumpSolve`：

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| maxRequestsThisTick | int | >= 0 | 本 tick 允许求解的最大请求数（预算入口） |

`PumpApplyResults`：

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| maxResultsThisTick | int | >= 0 | 本 tick 允许写回/回收的最大结果数（预算入口） |

### 返回值

- `TryEnqueue`：成功入队 true；失败 false 并给出 error。
- `PumpSolve/PumpApplyResults`：返回本次实际处理数量（用于统计与调参）。

### 异常/错误码

错误码建议至少包含：

- QueueFull：请求队列满（必须丢弃并计数）
- InvalidRequest：请求字段非法（缺少 GraphId、预算为 0 等）
- NotReady：依赖未就绪（例如 corridor 对应 chunk 未加载）

### 线程安全性

- `TryEnqueue/TryDequeueResult`：可设计为多生产者/单消费者，但必须给出明确约束并提供验证入口。
- `PumpSolve/PumpApplyResults`：必须在主线程或指定调度阶段调用；不得与图写阶段并发。

## 2.2 IPathStore（路径句柄与数据访问）

### 签名

```csharp
bool TryGetPath(in PathHandle handle, out PathSpan path);
bool Release(in PathHandle handle);
```

### 参数说明

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| handle | PathHandle | Index+Generation | 路径句柄，必须做 generation 校验 |
| path | PathSpan(out) | 只读视图 | 路径数据只读视图，不暴露可写裸指针 |

### 返回值

- `TryGetPath`：handle 有效且路径仍存在则 true，否则 false。
- `Release`：释放成功 true；handle 无效/已释放 false。

### 异常/错误码

- 禁止抛出异常作为常规控制流；无效 handle 返回 false。

### 线程安全性

- PathStore 读接口可并发，但生命周期回收必须有明确阶段（通常在 ApplyResults/回收阶段统一执行）。

## 2.3 IGraphProjection（世界坐标到图节点投影）

### 签名

```csharp
bool TryProject(in WorldPosCm pos, int graphId, out int nodeId, out ProjectError error);
```

### 参数说明

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| pos | WorldPosCm | cm | 世界坐标（厘米真源） |
| graphId | int | >= 0 | 目标图/层 |
| nodeId | int(out) | [0, NodeCount) | 投影后的节点 ID |
| error | ProjectError(out) | enum | 投影失败原因（无可达点/图未加载/超范围等） |

### 返回值

- 成功 true；失败 false 并给出 error。

### 异常/错误码

- NotLoaded：目标图未加载或缺少 corridor
- NoCandidate：附近无可达节点

### 线程安全性

- 投影通常依赖空间索引；并行访问必须遵循空间服务的线程安全约束。

# 3 使用约束

## 3.1 生命周期与所有权

- 上层只拥有 PathHandle，不拥有路径数据内存；路径数据的所有权属于 PathStore。
- 旧路径 handle 的释放应在结果写回阶段集中处理，禁止散落在业务系统中。

## 3.2 容量与预算

- RequestQueue/ResultQueue：固定容量，溢出必须丢弃并计数。
- Solve budget：每 tick 最大求解请求数 + 每请求 maxExpanded 必须存在。
- Corridor budget：半径与最大 chunk 数必须存在，超限降级必须可观测。

## 3.3 失败策略

- QueueFull/NotReady/BudgetExceeded：必须以明确状态返回，禁止静默 fallback。
- InvalidRequest：必须 fail-fast（拒绝入队）并提供证据入口（统计/断言之一）。

# 4 代码入口

## 4.1 接口定义位置

当前接口以“实现入口 + 规范文档”形式存在（待抽象为显式接口文件）：

- `src/Core/Navigation/GraphEcs/GraphPathComponents.cs`
- `src/Core/Navigation/GraphEcs/GraphPathfindingSystem.cs`

## 4.2 关键实现位置

- 图与求解：`src/Core/Navigation/GraphCore/*`
- streaming/corridor：`src/Core/Navigation/GraphWorld/*`
- AOI：`src/Core/Navigation/AOI/*`

## 4.3 相关测试与对齐文档

- `docs/04_游戏逻辑/10_导航寻路/05_对齐报告/01_导航寻路_对齐报告.md`

