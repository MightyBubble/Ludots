---
文档类型: 对齐报告
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 04_游戏逻辑 - 导航寻路 - 规范对齐
状态: 草案
---

# 导航寻路 对齐报告

# 1 摘要

## 1.1 结论

当前导航核心（NodeGraph + A* + TraversalPolicy/Overlay + chunk store）已具备大世界演进方向的关键基础，但在 64km×64km 场景下仍存在两类高风险缺口：

1. 请求/结果缺少统一固定容量队列与预算化口径（多生产者场景帧耗不可预测）。
2. GraphWorld 的 LoadedView 装配倾向全量合图重建（streaming 场景会成为 CPU/分配热点）。

## 1.2 风险等级与影响面

- 风险等级：高
- 影响面：
  - AI 大规模单位同时请求路径时的帧耗稳定性
  - streaming 频繁变化下的整体 CPU 与分配抖动
  - 路径失效与重算策略的一致性与可审计性

## 1.3 建议动作

优先级从高到低：

1. 固化 PathRequest/PathResult 与 RequestQueue/ResultQueue 固定容量与 dropped 统计口径。
2. 固化 PathStore/PathHandle（Index+Generation），剥离组件内的路径本体。
3. GraphWorld 引入 corridor 局部视图缓存与版本化口径，降低装配成本。

# 2 审计范围与方法

## 2.1 审计范围

范围覆盖：

- 图与求解：`src/Core/Navigation/GraphCore/*`
- ECS 接入：`src/Core/Navigation/GraphEcs/*`
- 分块装配：`src/Core/Navigation/GraphWorld/*`
- AOI：`src/Core/Navigation/AOI/*`

## 2.2 审计方法

- 以本目录口径为准：`docs/04_游戏逻辑/10_导航寻路/*`
- 逐项对齐代码入口：检查是否存在对应实现、是否满足预算与不变量、是否存在禁止事项（隐式扩容/静默降级/全量合图重建等）。

## 2.3 证据口径

- 证据必须为仓库相对路径，必要时补充关键函数/类型名（不使用本机绝对路径与本地链接）。

# 3 差异表

## 3.1 差异表

| 设计口径 | 代码现状 | 差异等级 | 风险 | 证据 |
|---|---|---|---|---|
| RequestQueue/ResultQueue 固定容量 + dropped 统计 | 以组件直驱为主，队列与 dropped 口径未固化为统一接口 | 高 | 并发请求时帧耗不可预测；难以审计超限行为 | `src/Core/Navigation/GraphEcs/GraphPathfindingSystem.cs` |
| PathHandle 必须 Index+Generation，组件不存路径本体 | 当前路径存储形态需要统一；句柄化与回收边界未固化 | 中 | 生命周期错误导致悬挂引用或回放差异 | `src/Core/Navigation/GraphEcs/GraphPathComponents.cs` |
| 禁止频繁全量合图重建；corridor 内装配需缓存/增量 | LoadedView 装配存在全量合并重建风险路径 | 高 | streaming 高频变化时成为热点（CPU/分配抖动） | `src/Core/Navigation/GraphWorld/ChunkedNodeGraphStore.cs` |
| corridor 必须可预算与可审计 | corridor 选择工具存在，但预算/审计字段未固化为统一契约 | 中 | corridor 可能失控膨胀，导致局部求解退化 | `src/Core/Navigation/GraphWorld/GraphCorridorChunkSelector.cs` |
| Overlay 版本化用于结果失效判定 | Overlay 能力存在，但版本化口径需要统一纳入请求/结果统计 | 中 | 路径失效判定与重算策略不稳定 | `src/Core/Navigation/GraphCore/GraphEdgeCostOverlay.cs` |

# 4 行动项

## 4.1 行动项清单

1. 固化 PathRequest/PathResult 与固定容量队列接口
   - 负责人：X28技术团队
   - 优先级：P0
   - 验收条件：超出容量时丢弃并计数；BudgetExceeded/NotReady 以明确状态返回；无隐式扩容与静默降级。

2. 引入 PathStore/PathHandle（Index+Generation）并剥离组件内路径本体
   - 负责人：X28技术团队
   - 优先级：P0
   - 验收条件：组件仅保存 handle；handle 校验失败可观测；旧 handle 回收集中化。

3. GraphWorld：corridor 局部视图缓存与版本化口径
   - 负责人：X28技术团队
   - 优先级：P1
   - 验收条件：streaming 高频变化下不出现每次全量合图重建；LoadedView 装配具备缓存命中统计与版本策略。

