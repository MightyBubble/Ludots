---
文档类型: 裁决条款
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 04_游戏逻辑 - 导航寻路 - 64km 分层与合图
状态: 已裁决
---

# 64km 分层导航与合图 裁决条款

# 1 裁决背景

## 1.1 背景问题与约束

目标世界规模为 64km×64km。在此规模下，以下问题是决定性约束：

- 图数据不可能全域常驻并支持高频更新与高频查询（CPU 与内存不可控）。
- streaming 场景下，加载集合频繁变化，若每次变化都全量合图重建，会成为帧耗热点并引入分配抖动。
- AI/GAS/GraphRuntime 可能同时产生大量路径请求，必须预算化，否则帧耗不可预测。

## 1.2 适用范围与边界

适用范围：

- 任何跨 chunk 的路径规划与动态封路/改权导致的路径失效场景。

不适用：

- 小规模固定场景可采用更简单方案，但仍必须遵守“请求预算化与失败策略显式化”。

# 2 裁决结论

## 2.1 必须遵守的规则

1. 必须采用分层导航（L0/L1/L2）。
   - L0：骨干层（chunk/portal 图）负责长距离规划与 streaming 约束。
   - L1：走廊层（corridor）显式给出局部装配范围。
   - L2：局部层仅在 corridor 内求解精确路径（A*）。

2. corridor 必须显式、可审计、可预算。
   - 必须记录 corridorRadius、chunkCount、降级原因（枚举/ID 化）。
   - corridor 超预算必须熔断并返回明确状态（CoarseOnly/NotReady/BudgetExceeded），禁止静默扩张。

3. 禁止频繁全量合图重建。
   - 禁止在 streaming 或每次请求时，对已加载集合执行全量拷贝并重建 CSR 的全局图。
   - 允许：仅在 corridor 内装配局部视图，且必须具备缓存复用或增量策略。

4. 请求/结果必须队列化与预算化。
   - RequestQueue/ResultQueue 固定容量；溢出必须丢弃并计数，不允许扩容。
   - 每请求必须携带 maxExpanded；超限必须返回 BudgetExceeded。

## 2.2 例外条件与退出条件

例外条件（仅用于小规模固定地图的临时阶段）：

- 例外触发条件：
  - 地图规模可证明上界足够小（节点/边规模在预算内），且不会发生 streaming。
  - 仅单系统、低并发请求，并能证明全量合图不会产生帧耗热点。
- 例外退出条件（强制）：
  - 一旦启用 streaming，或出现多系统并发请求，必须立即切回分层导航与 corridor 约束。
  - 任何性能基准显示合图装配成为热点时，必须回退例外方案。

# 3 裁决理由

## 3.1 为什么这样做

- 分层与 corridor 是大世界可控搜索空间的必要手段：把全域问题降维到可预算的局部问题。
- 禁止全量合图重建是为了避免装配成本吞噬算法优化收益。
- 队列化与预算化确保帧耗稳定：导航属于可批处理、可固定上界的计算问题。

## 3.2 放弃了哪些备选方案

- 备选A：全域 RouteTable（all-pairs）。
  - 放弃原因：n² 内存与构建成本不可能覆盖大世界，只能用于骨干小图。
- 备选B：整包引入外部导航插件作为主实现。
  - 放弃原因：外部插件往往与平台/工具链强耦合；大世界瓶颈在 streaming 与一致性边界，必须与本项目基建统一后才能可靠落地。

# 4 影响范围

## 4.1 受影响模块与代码入口

- `src/Core/Navigation/GraphCore/*`
- `src/Core/Navigation/GraphWorld/*`
- `src/Core/Navigation/GraphEcs/*`
- `src/Core/Navigation/AOI/*`

## 4.2 迁移与过渡策略

1. 先固化 RequestQueue/ResultQueue 与 dropped 统计口径（使超限可观测）。
2. 固化 PathStore/PathHandle（Index+Generation），将路径本体从组件中剥离。
3. GraphWorld 引入 corridor 局部视图缓存与版本化口径，避免高频全量合图重建。
4. 在 L0 骨干层定义 ChunkGraph 的数据口径，并限定 RouteTable 仅用于小图。

