---
文档类型: 接口规范
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 地图数据集与叠加口径
状态: 草案
---

# 地图数据集与叠加口径 接口规范

# 1 概述
## 1.1 本文档定义

本文档定义“地图数据集（MapDataSet）”的目标口径，用于表达地图加载后可选择性加载的 Hex(Vertex)/Grid/Graph，并定义它们在地图叠加（Core+Mods+Parent 链）场景下的唯一性与合并策略。

本文档属于“接口规范”：用于约束 MapConfig/资产写法与加载器的裁决行为，避免 silent override 与口径漂移。

## 1.2 术语与约定

- 最终地图：对某个 MapId 执行 Core+Mods 片段合并 + Parent 继承合并后得到的最终 MapConfig 视图。
- 数据集：地图加载后注入 MapLoaded 上下文的可选数据块（Hex/Grid/Graph 等）。
- 叠加：多个来源为同一 MapId 提供内容，最终合并为一个确定结果。

## 1.3 关键约束

- Hex(Vertex) 唯一：对“最终地图”而言，Hex(Vertex) 真源最多 1 份；不允许多来源冲突后静默覆盖。
- Grid/Graph 可多份：对“最终地图”而言，Grid/Graph 可多份并存；同一 id 的合并必须显式可解释（mergePolicy）。
- 禁止 silent override：任何不兼容覆盖必须在加载期失败并输出证据。

# 2 核心接口
## 2.1 MapDataSet（目标形态）
### 签名

逻辑结构（目标形态，供 MapConfig 承载）：

- `MapDataSet[] DataSets`

### 参数说明

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| kind | string | `HexVertex`/`Grid`/`Graph` | 数据集类型 |
| id | string | 稳定标识 | 同 kind 下用于定位与合并 |
| path | string | 相对路径 | 资产路径（相对 assets 根） |
| format | string | 可选 | 格式标识（用于校验与迁移） |
| mergePolicy | string | `Replace`/`Merge`/`Additive` | 合并策略（同 id 多来源时） |
| tags | string[] | 可选 | 数据集标签（用途/消费方筛选） |

### 返回值

- 加载器根据 DataSets 裁决并产出“最终数据集集合”，注入 MapLoaded 上下文。

### 异常/错误码

- 数据集缺失/格式错误/合并冲突：加载期失败并输出 `kind/id/source/path` 等证据。

### 线程安全性

- 纯配置结构；线程安全问题由运行时容器的读写策略定义。

## 2.2 Hex(Vertex) 唯一性裁决
### 签名

裁决规则（最终地图维度）：

- `Count(DataSets where kind == HexVertex) <= 1`

### 参数说明

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| mapId | string | MapId | 被裁决的地图标识 |
| sources | string[] | VFS URI/路径 | 提供该数据集的来源集合 |

### 返回值

- 若不存在 HexVertex 数据集：VertexMap 可为 null（地图不提供 Hex 地形）。
- 若存在 1 个：加载其资产并注入 VertexMap。

### 异常/错误码

- 若出现多个且不一致：加载期失败，错误必须包含冲突来源证据。

### 线程安全性

- 裁决阶段单线程即可；运行期只读或写入策略由编辑器/工具链决定。

# 3 使用约束
## 3.1 生命周期与所有权

- 数据集裁决发生在 LoadMap 期间；MapLoaded 之后，消费方只读取上下文中已注入的“最终数据集集合”。
- 切图（加载新 MapId）时，数据集集合整体替换，按 map 维度隔离。

## 3.2 容量与预算

- Grid fine 可能非常大；必须约束更新频率与内存占用，避免把 fine grid 当作每帧全量更新目标。
- Graph corridor view 装配应谨慎控制范围，避免加载期或运行期装配成本膨胀。

## 3.3 失败策略

- 目标口径：所有不一致/缺失/格式错误都在加载期 fail-fast；禁止 silent override 与运行期猜测。

# 4 代码入口
## 4.1 接口定义位置

- 现状：MapConfig 为历史字段形态（`DataFile` + `Entities`），未来将扩展承载 DataSets
  - `src/Core/Config/MapConfig.cs`

## 4.2 关键实现位置

- MapConfig 合并：`src/Core/Map/MapManager.cs`
- Hex(Vertex) 加载：`src/Core/Engine/GameEngine.cs`（LoadVertexMap）
- Graph 基建（路网）：`src/Core/Navigation/*`
- GASGraph（技能图）：`src/Core/Gameplay/GAS/Graph/*`（仅用于技能图，不属于路网）

## 4.3 相关测试与对齐文档

- `docs/04_游戏逻辑/09_地图与地形/05_对齐报告/02_地图多数据集加载对齐报告.md`
