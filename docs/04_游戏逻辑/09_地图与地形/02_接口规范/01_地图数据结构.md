---
文档类型: 接口规范
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 地图数据结构
状态: 草案
---

# 地图数据结构 接口规范

# 1 概述
## 1.1 本文档定义

本文档定义地图系统的核心数据结构与文件格式口径：MapId/MapConfig/MapDefinition/WorldMap/VertexMapBinary。该口径用于对齐 Core 与 Mods 的数据写法与加载行为。

## 1.2 术语与约定

- MapId：地图标识，建议以小写 + 下划线（例如 `entry`、`benchmark_map`）。
- “仓库相对路径”：以仓库根为基准，例如 `src/Core/Config/MapConfig.cs`。
- “VFS URI”：`ModId:relative/path`。

## 1.3 关键约束

- MapConfig schema 必须与 `src/Core/Config/MapConfig.cs` 一致；不允许保留旧 schema 并静默兼容。
- 地形二进制必须符合 `VertexMapBinary` 的 magic/version 约束；不允许运行时猜测版本。

# 2 核心接口
## 2.1 MapId
### 签名

`readonly struct MapId`

### 参数说明

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| value | string | 非空字符串（允许空但不推荐） | 地图标识；比较使用 OrdinalIgnoreCase |

### 返回值

- `MapId.Value`：规范化后的字符串（Trim 后，null → 空字符串）

### 异常/错误码

- 无

### 线程安全性

- 值类型，线程安全。

## 2.2 MapConfig（JSON）
### 签名

`class MapConfig`

### 参数说明

| 字段 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| Id | string | MapId 字符串 | 地图标识（建议与请求的 MapId 一致） |
| ParentId | string | MapId 字符串 | 父地图标识；存在时加载期合并 parent→child |
| DataFile | string | 相对路径（/、\\ 开头会被裁剪） | 地形二进制文件相对路径；由加载器补全候选前缀 |
| Dependencies | object(map) | key=依赖标识，value=版本字符串 | 依赖约束（当前代码仅合并，不做强校验） |
| Tags | string[] | 去重集合 | 地图标签；用于 feature flags/玩法分流等 |
| Entities | EntitySpawnData[] | 追加列表 | 实体生成清单（模板 + Overrides） |

### 返回值

- MapConfig 作为“地图内容编排”的合并结果，在加载完成后用于实体装配与上下文注入。

### 异常/错误码

- JSON schema 不匹配应在加载期失败并给出定位信息（目标口径）；当前实现存在吞错，详见对齐报告。

### 线程安全性

- 纯数据对象；读取线程安全，写入需外部同步。

### 示例

```json
{
  "Id": "entry",
  "Tags": ["moba_demo"],
  "DataFile": "entry.vtxm",
  "Dependencies": { "SomeMod": "1.0.0" },
  "Entities": [
    { "Template": "moba_hero", "Overrides": { "WorldPositionCm": { "Value": { "X": 0, "Y": 0 } } } }
  ]
}
```

## 2.3 VertexMapBinary（地形二进制）
### 签名

`static class VertexMapBinary`

### 参数说明

| 字段 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| magic | ASCII(4) | 固定为 `VTXM` | 文件魔数 |
| version | int32 | 当前为 2 | 版本号；不匹配即失败 |
| widthChunks | int32 | >0 | 地图宽（chunk） |
| heightChunks | int32 | >0 | 地图高（chunk） |
| chunkSize | int32 | 固定为 `VertexChunk.ChunkSize` | chunk 边长（cell） |

### 返回值

- Read：返回初始化后的 VertexMap（按 chunk 填充多层数据）。

### 异常/错误码

- magic/version/chunkSize 不匹配：抛出 InvalidDataException。
- 读取中断：抛出 EndOfStreamException。

### 线程安全性

- Read/Write 过程对 stream 有独占假设；调用方负责并发控制。

# 3 使用约束
## 3.1 生命周期与所有权

- MapConfig 的最终结果由 MapManager 生成并传递给 MapLoader/LoadVertexMap；运行期应视为只读。
- VertexMap 由加载期创建并注入 ContextKeys；运行期可读，写入需明确的编辑器/工具链。

## 3.2 容量与预算

- `VertexMapBinary.Read` 会按 chunk 读取并分配缓冲区；切图频繁时应关注 GC/分配。

## 3.3 失败策略

- 目标口径：缺文件、schema 错误、版本不匹配都在加载期 fail-fast，并给出“候选路径/来源 ModId/字段名”等证据。

# 4 代码入口
## 4.1 接口定义位置

- `src/Core/Map/MapId.cs`
- `src/Core/Config/MapConfig.cs`
- `src/Core/Map/MapDefinition.cs`
- `src/Core/Map/Hex/VertexMapBinary.cs`

## 4.2 关键实现位置

- `src/Core/Map/MapManager.cs`
- `src/Core/Engine/GameEngine.cs`

## 4.3 相关测试与对齐文档

- `docs/04_游戏逻辑/09_地图与地形/05_对齐报告/01_地图架构对齐报告.md`
- `docs/04_游戏逻辑/09_地图与地形/05_对齐报告/02_地图多数据集加载对齐报告.md`
