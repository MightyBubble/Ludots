---
文档类型: 对齐报告
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 多数据集加载
状态: 草案
---

# 地图多数据集加载 对齐报告

# 1 摘要
## 1.1 结论

- 目标口径：每张最终地图（MapId 合并后视图）可选择性加载 Hex/Grid/Graph；Hex(Vertex) 对该地图唯一，Grid/Graph 允许多份叠加；实体装配按模板先、Overrides 后执行。
- 代码现状：Hex(VertexMap) 加载链路已可用但失败策略偏宽松；Grid 仅有 WorldMap 容器且二进制加载占位；路网 Graph 基建完整但未接入地图加载；GASGraph 已接入引擎初始化但与路网 Graph 需严格区分。

## 1.2 风险等级与影响面

- 风险等级：中-高
- 影响面：
  - 地图叠加（Core/Mods/Parent）：Vertex 冲突可能被静默覆盖；Grid/Graph 无法成为地图真源，业务侧只能绕过加载边界。
  - 诊断与维护：Graph 概念混淆（路网 vs GASGraph）会导致接口与上下文命名跑偏。

## 1.3 建议动作

- P1：以文档为裁决先行：明确 MapDataSet/叠加策略/Vertex 唯一性维度，并补齐 Hex/Grid/Graph 的 MapLoaded 上下文契约。
- P1：优先接线 Graph（已有基建与测试），把“路网真源”真正挂到地图加载之后。
- P2：Grid 先落地运行时容器与接口，再落地资产格式与加载器，避免口径不清时做无效优化。

# 2 审计范围与方法
## 2.1 审计范围

- 地图加载：`src/Core/Engine/GameEngine.cs`、`src/Core/Map/MapManager.cs`、`src/Core/Systems/MapLoader.cs`
- Hex(VertexMap)：`src/Core/Map/Hex/*`
- Grid(WorldMap)：`src/Core/Map/WorldMap.cs`、`src/Core/Map/MapTile.cs`
- Graph 路网：`src/Core/Navigation/*`（GraphCore/GraphWorld/MultiLayerGraph/GraphSemantics）
- GASGraph：`src/Core/Gameplay/GAS/Graph/*`
- 文档：`docs/04_游戏逻辑/09_地图与地形/*`

## 2.2 审计方法

- 沿 LoadMap 主链路追踪“加载期注入点”与失败策略。
- 对比三套系统（Hex/Grid/Graph）的“是否已接入 LoadMap/MapLoaded”。
- 检查“叠加”语义在配置层（MapConfig/模板/Entities）与数据层（Vertex/Grid/Graph）的一致性。

## 2.3 证据口径

- 证据均为仓库相对路径；不得写本机绝对路径或 file scheme。

# 3 差异表
## 3.1 差异表
| 设计口径 | 代码现状 | 差异等级 | 风险 | 证据 |
|---|---|---|---|---|
| Hex(Vertex) 可选且每张最终地图唯一 | `MapConfig.DataFile` 可空；但多来源 DataFile 会被后者覆盖且缺失文件可静默 return | P1 | 地图叠加时出现静默覆盖/缺地形，难定位 | `src/Core/Engine/GameEngine.cs`<br>`src/Core/Map/MapManager.cs` |
| Grid 支持 coarse/fine 与多份并存，加载后注入上下文 | 仅有单实例 WorldMap 容器；LMAP 加载占位；无 coarse/fine 抽象 | P2 | 天气/流场无法有稳定数据接口，默认值掩盖错误 | `src/Core/Map/WorldMap.cs`<br>`src/Core/Systems/MapLoader.cs` |
| Graph 路网支持多份/多层/overlay，并在地图加载后可用 | GraphCore/GraphWorld/MultiLayer/Overlay 基建与测试齐全，但未接入地图加载流程 | P1 | 路网无法成为地图真源，业务侧需要旁路构建 | `src/Core/Navigation/*`<br>`src/Tests/GasTests/GraphNetworkTests.cs` |
| Graph 叠加：静态 overlay + 运行期 overlay | overlay 数据结构与 GAS sink 已存在，但缺少地图级静态 overlay 加载入口与注入契约 | P2 | 动态封路/成本调整难以形成统一口径 | `src/Core/Navigation/GraphCore/GraphEdgeCostOverlay.cs`<br>`src/Core/Navigation/GraphSemantics/GAS/GraphEdgeCostOverlaySink.cs` |
| 明确区分路网 Graph 与 GASGraph（技能图） | 引擎已加载 GASGraph 到 GraphProgramRegistry；与路网 Graph 文档/命名若不隔离易混用 | P2 | 概念混淆导致接口扩展方向跑偏 | `src/Core/Gameplay/GAS/Graph/GraphProgramLoader.cs`<br>`src/Core/Engine/GameEngine.cs` |
| 实体示例初始化：模板先、Overrides 后；Entities 列表叠加 | 现状符合该口径（模板合并、实体生成、Overrides 顺序），但失败策略与诊断仍偏宽松 | P2 | 配置错误不易定位；未来收紧 fail-fast 需要迁移策略 | `src/Core/Systems/MapLoader.cs`<br>`src/Core/Config/EntityBuilder.cs`<br>`assets/Configs/Maps/entry.json` |

# 4 行动项
## 4.1 行动项清单

| ID | 动作 | Owner | 优先级 | 验收条件 | 证据入口 |
|---|---|---|---|---|---|
| MAP-MD-01 | 补齐 MapDataSet 与叠加口径文档并作为裁决依据 | X28技术团队 | P1 | 明确 Hex 唯一性维度、Grid/Graph 多份叠加策略、错误口径与命名规范 | `docs/04_游戏逻辑/09_地图与地形/02_接口规范/02_地图数据集与叠加口径.md` |
| MAP-MD-02 | 补齐 Grid/Graph/实体装配流程文档并对齐现状 | X28技术团队 | P1 | Grid/Graph/实体装配三篇架构设计文档能准确描述现状与缺口 | `docs/04_游戏逻辑/09_地图与地形/01_架构设计/*` |
| MAP-MD-03 | 规划 Graph 路网接线（GraphRegistry 注入 MapLoaded） | X28技术团队 | P1 | MapLoaded 可定位 GraphId；多份/多层/overlay 叠加策略可执行 | `src/Core/Navigation/*` |
| MAP-MD-04 | 规划 Grid coarse/fine 接口（GridRegistry + 最小容器） | X28技术团队 | P2 | MapLoaded 可定位 coarse/fine；缺资产/不兼容能在加载期定位 | `src/Core/Map/WorldMap.cs` |
| MAP-MD-05 | 统一错误诊断策略（吞错→证据化 fail-fast） | X28技术团队 | P1 | MapConfig/数据集/模板/Overrides 的错误均包含来源与路径证据 | `src/Core/Map/MapManager.cs`<br>`src/Core/Engine/GameEngine.cs` |
