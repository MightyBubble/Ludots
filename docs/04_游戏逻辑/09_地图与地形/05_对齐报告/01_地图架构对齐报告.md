---
文档类型: 对齐报告
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 地图架构
状态: 草案
---

# 地图架构 对齐报告

# 1 摘要
## 1.1 结论

- 当前地图架构已形成清晰主链路（GameEngine 编排、MapManager 合并、MapLoader 装配、VertexMapBinary 读写），但“加载期强约束（fail-fast）”与“schema/路径契约”尚未落地，存在配置被吞错后静默退化的风险。
- 地形层面同时存在 WorldMap 与 VertexMap 两套表示，缺少“真源与消费方边界”的强约束，存在口径漂移隐患。
- 对齐新增目标口径：每张最终地图（MapId 的最终合并结果）允许选择性加载 Hex/Grid/Graph；其中 Hex(Vertex) 对该地图必须唯一，Grid/Graph 允许多份并存与叠加。当前代码对该口径的接线与裁决尚未落地。

## 1.2 风险等级与影响面

- 风险等级：高
- 影响面：
  - 地图/Mod 配置作者：schema 与路径不一致会导致地图不可加载或静默缺地形
  - 运行期系统：拿到 null/默认地形后可能在后续系统中以更隐蔽方式崩溃或产生不一致表现

## 1.3 建议动作

- P0：把“吞异常/静默返回”改为加载期显式失败，并输出可定位证据（候选路径、来源 ModId、字段名）。
- P0：统一 MapConfig schema（尤其 Dependencies）并对仓库内不合规配置做一次性迁移。
- P1：收敛 MapConfig 与 DataFile 的路径约定到单点定义，并补齐最小示例资产与校验用例。
- P1：明确地形真源（WorldMap vs VertexMap）与消费方边界，并在 MapLoaded 上下文中提供一致契约。
- P1：补齐“地图数据集（Hex/Grid/Graph）选择性加载与叠加口径”的接口规范与对齐报告（作为后续代码落地的裁决依据）。

# 2 审计范围与方法
## 2.1 审计范围

- 文档范围：`docs/04_游戏逻辑/09_地图与地形/*`（总览、架构设计、接口规范、对齐报告等）
- 代码范围：地图加载与地形相关核心模块（GameEngine/MapManager/MapLoader/VFS/WorldMap/VertexMap）
- 数据范围：仓库内 Core 与 Mods 的地图配置 JSON

## 2.2 审计方法

- 静态审计：沿 LoadMap 主链路追踪调用关系与异常/失败策略。
- 配置核对：抽样检查 Core 与 Mods 下地图配置文件与代码 schema 的匹配度。
- 口径对齐：对照文档中的目标约束（SSOT/fail-fast/边界）与代码现状逐条比对。

## 2.3 证据口径

- 证据必须为仓库相对路径；同一条差异可列多个证据路径。
- 不引用本机绝对路径、不使用 file scheme 链接。

# 3 差异表
## 3.1 差异表
| 设计口径 | 代码现状 | 差异等级 | 风险 | 证据 |
|---|---|---|---|---|
| 缺 MapConfig/schema 错误应加载期 fail-fast，并输出可定位信息 | MapManager 读取配置时 `catch { /* Ignore */ }` 吞掉所有异常；配置 schema 错误会表现为“地图不存在” | P0 | 配置错误难定位；线上出现“部分 Mod 地图加载失败但无原因” | `src/Core/Map/MapManager.cs` |
| 地图声明 DataFile 后应保证地形二进制确定性加载/失败 | LoadVertexMap 在找不到文件时静默 return；仅在读流抛异常时打印一条日志 | P0 | 地形缺失被默认值掩盖，后续系统可能以更隐蔽方式出错 | `src/Core/Engine/GameEngine.cs` |
| MapConfig schema 与仓库样例一致，禁止旧 schema 静默兼容 | `MapConfig.Dependencies` 为 Dictionary，但仓库内部分地图配置写为数组（`Dependencies: []`）；反序列化会抛异常并被吞掉 | P0 | Mod 地图配置在当前版本不可用且难定位 | `src/Core/Config/MapConfig.cs`<br>`assets/Mods/ExampleMod/assets/maps/example_map.json`<br>`assets/Mods/PerformanceMod/assets/maps/benchmark_map.json` |
| 资源路径约定应集中定义且在 Core/Mods 上一致 | MapManager 与 LoadVertexMap 各自硬编码多套候选路径前缀（`Configs/`、`assets/`、`assets/Data/Maps/`），且 Core/Mod 的目录结构语义混杂 | P1 | 新增地图资产时容易放错位置；不同模块查找规则不一致导致“能读配置但读不到地形” | `src/Core/Map/MapManager.cs`<br>`src/Core/Engine/GameEngine.cs` |
| 地形几何真源应唯一或至少明确优先级与消费边界 | WorldMap 与 VertexMap 并存；缺少文档化的“谁是几何真源/哪些系统依赖哪个”强约束 | P1 | 可行走性/渲染/碰撞口径漂移，出现体验不一致 | `src/Core/Map/WorldMap.cs`<br>`src/Core/Map/Hex/VertexMap.cs` |
| Hex(Vertex) 在“最终地图维度”必须唯一，禁止 silent override | MapConfig 多片段合并时 `DataFile` 会被后者覆盖；无冲突检测，且缺失文件可静默 return | P1 | 多 Mod/继承叠加时出现“最后写的人覆盖前者”且难定位 | `src/Core/Map/MapManager.cs`<br>`src/Core/Engine/GameEngine.cs` |
| 路网 Graph 应能在地图加载后选择性加载并注入上下文 | 路网 Graph 基建（NodeGraph/ChunkedStore/MultiLayer/Overlay）较完整且测试覆盖明显，但未接入 LoadMap/MapLoaded | P1 | 路网能力只能以“手工构建/测试用例”存在，无法成为地图真源 | `src/Core/Navigation/*`<br>`src/Tests/GasTests/GraphNetworkTests.cs` |
| Grid 应支持 coarse/fine 与多份并存，并有明确加载入口 | WorldMap/MapTile 仅提供单实例容器；LMAP 加载为占位；无 coarse/fine 与多场数据集抽象 | P2 | 天气/流场等系统缺少稳定数据接口，容易出现“默认值掩盖缺资产” | `src/Core/Map/WorldMap.cs`<br>`src/Core/Systems/MapLoader.cs` |
| 必须区分路网 Graph 与 GASGraph（技能图） | 引擎已接入 GraphProgramLoader/GraphProgramRegistry（GASGraph），容易在命名与文档上与路网 Graph 混用 | P2 | 业务侧错误依赖与概念混淆，导致接口扩展方向跑偏 | `src/Core/Gameplay/GAS/Graph/GraphProgramLoader.cs`<br>`src/Core/Engine/GameEngine.cs` |
| MapConfig 继承应具备循环检测与强校验 | ParentId 递归加载无 cycle 检测；Id 一致性未校验（片段 Id 与请求 MapId 可能不一致） | P2 | 配置错误可能导致栈溢出或不可预期合并结果 | `src/Core/Map/MapManager.cs` |
| MapDefinition/依赖元数据应清晰且不留未使用字段 | MapManager 中 triggerManager 字段未使用；MapDefinition.Dependencies 未进入加载裁决；DataFilePath/MapConfig.DataFile 语义易混淆 | P2 | 维护成本上升；后续扩展容易走错口径 | `src/Core/Map/MapManager.cs`<br>`src/Core/Map/MapDefinition.cs` |
| 实体装配应避免遗留分支与不必要的运行期开销 | MapLoader 仍保留 LMAP 旧格式解析占位；LoadEntities 每次构建模板字典快照 | P2 | 代码噪音与潜在性能浪费 | `src/Core/Systems/MapLoader.cs` |

# 4 行动项
## 4.1 行动项清单

| ID | 动作 | Owner | 优先级 | 验收条件 | 证据入口 |
|---|---|---|---|---|---|
| MAP-A01 | MapManager/LoadVertexMap 改为加载期 fail-fast + 诊断信息（候选路径/来源 ModId/schema 字段） | X28技术团队 | P0 | 请求不存在地图、schema 错误、DataFile 缺失/版本错时均能在加载期明确失败并定位 | `src/Core/Map/MapManager.cs`<br>`src/Core/Engine/GameEngine.cs` |
| MAP-A02 | 统一 Dependencies schema，并迁移仓库内不合规地图配置 | X28技术团队 | P0 | `assets/**/maps/*.json` 全量满足当前 schema；加载期对旧 schema 明确报错 | `src/Core/Config/MapConfig.cs`<br>`assets/Mods/**/assets/maps/*.json` |
| MAP-A03 | 收敛地图配置与地形二进制的路径约定到单点定义并补齐测试 | X28技术团队 | P1 | 候选路径规则不重复且有自动化验证；文档写明唯一约定 | `src/Core/Map/MapManager.cs`<br>`src/Core/Engine/GameEngine.cs`<br>`docs/04_游戏逻辑/09_地图与地形/01_架构设计/01_地图加载流程.md` |
| MAP-A04 | 明确地形真源（WorldMap vs VertexMap）与消费方边界，并更新文档/ContextKeys 契约 | X28技术团队 | P1 | 文档明确“谁依赖谁”；消费方不会同时读两套真源产生漂移 | `src/Core/Map/WorldMap.cs`<br>`src/Core/Map/Hex/VertexMap.cs` |
| MAP-A05 | 提供最小 VTXM 示例资产与校验用例（或离线校验工具） | X28技术团队 | P1 | 仓库内至少 1 个 VTXM + MapConfig 引用可稳定加载；坏文件用例可验证失败策略 | `src/Core/Map/Hex/VertexMapBinary.cs`<br>`assets/**` |
| MAP-A06 | 落地“最终地图维度 Vertex 唯一”裁决与诊断输出 | X28技术团队 | P1 | 多来源 DataFile 冲突时明确失败并输出冲突来源证据；同一来源/同一路径可复用 | `src/Core/Map/MapManager.cs`<br>`src/Core/Engine/GameEngine.cs` |
| MAP-A07 | 定义 MapDataSet（Hex/Grid/Graph）接口规范并接入 MapLoaded 上下文契约 | X28技术团队 | P1 | 文档与实现统一：Hex 可选且唯一；Grid/Graph 可选且可多份；命名与合并策略明确 | `docs/04_游戏逻辑/09_地图与地形/02_接口规范/02_地图数据集与叠加口径.md` |
| MAP-A08 | 路网 Graph 地图级加载接线（GraphRegistry + 可选 overlay） | X28技术团队 | P1 | 任一地图可声明并加载 GraphId；MapLoaded 上下文可定位；overlay 可叠加且可诊断 | `src/Core/Navigation/*` |
| MAP-A09 | Grid coarse/fine 运行时容器与最小加载入口（先接口后资产格式） | X28技术团队 | P2 | MapLoaded 提供 GridRegistry，至少支持 coarse/fine 两份并存；缺失资产可定位失败 | `src/Core/Map/WorldMap.cs` |
