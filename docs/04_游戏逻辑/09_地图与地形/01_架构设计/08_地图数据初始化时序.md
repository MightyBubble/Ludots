---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 地图数据初始化时序
状态: 草案
---

# 地图数据初始化时序 架构设计

# 1 设计概述
## 1.1 本文档定义

本文档定义地图相关基建的初始化时序与边界：引擎初始化、Mod 加载、模板/配置加载、地图加载、地图数据集（Hex/Grid/Graph）注入与地图后续初始化（MapLoaded）的阶段划分。

边界与非目标：

- 边界：只描述“地图数据与装配”的时序，不描述玩法系统（战斗/AI/经济）内部细节。
- 非目标：不在初始化阶段做静默 fallback；缺文件/不兼容应在加载期 fail-fast（目标口径）。

## 1.2 设计目标

- 事件边界清晰：MapLoaded 是地图加载完成的唯一边界事件。
- 可选数据集：Hex/Grid/Graph 都可以选择性存在；存在与否必须在 MapLoaded 上下文中可判断。
- 叠加语义稳定：map 叠加（Core/Mods/Parent）发生在加载期，运行期只消费最终裁决结果。

## 1.3 设计思路

- 采用“分阶段初始化”：
  1) 引擎基础设施 → 2) Mods 解析与挂载 → 3) 全局注册表加载（templates/effects/graphs 程序） → 4) 地图加载（MapConfig 合并 + 数据集裁决 + 数据加载 + 实体装配） → 5) MapLoaded 触发（后续系统初始化入口）

# 2 功能总览
## 2.1 术语表

- Engine Init：引擎初始化阶段（VFS/Trigger/ConfigPipeline/ECS/Spatial 等）。
- Global Registries：全局注册表（templates、effect templates、GASGraph programs 等）。
- Map Load：地图加载阶段（MapConfig 合并、Hex/Grid/Graph 数据集加载、实体装配）。
- MapLoaded：地图加载完成事件（TriggerManager.FireEvent(GameEvents.MapLoaded)）。

## 2.2 时序图（阶段级）

```
Initialize(assetsRoot, gameConfig)
  -> Mount VFS(Core)
  -> Create ModLoader / MapManager / ConfigPipeline
  -> Create World / WorldMap / Spatial services
  -> Load Mods (Mount VFS(mod assets), dependency order)
  -> InitializeCoreSystems (GAS 等核心系统)
  -> Load Global Registries:
       - templates.json
       - effect templates
       - GASGraph programs (graphs.bin)

LoadMap(mapId)
  -> Merge MapConfig (Core+Mods+Parent)
  -> Resolve Map DataSets (Hex unique; Grid/Graph multi)
  -> Load Hex (VertexMap, optional)
  -> Load Grid (coarse/fine, optional, multi)
  -> Load Graph (road network, optional, multi + overlay)
  -> Spawn Entities (template + overrides)
  -> Fire MapLoaded (ctx includes datasets + registries)
```

## 2.3 关联依赖

- 引擎初始化：`src/Core/Engine/GameEngine.cs`
- 触发器与事件：`src/Core/Scripting/TriggerManager.cs`、`src/Core/Scripting/GameEvents.cs`
- 地图配置合并：`src/Core/Map/MapManager.cs`
- 实体装配：`src/Core/Systems/MapLoader.cs`、`src/Core/Config/EntityBuilder.cs`
- Hex：`src/Core/Map/Hex/*`
- Grid：`src/Core/Map/WorldMap.cs`
- 路网 Graph：`src/Core/Navigation/*`
- GASGraph（技能图程序）：`src/Core/Gameplay/GAS/Graph/*`

# 3 业务设计
## 3.1 初始化阶段划分

- Phase 0：基础设施
  - VFS mount Core
  - TriggerManager/FunctionRegistry
  - ModLoader/MapManager/ConfigPipeline
  - ECS World/WorldMap/Spatial services
- Phase 1：Mods 加载
  - Mount mod assets
  - 解析依赖顺序并冻结 LoadedModIds
- Phase 2：全局注册表加载
  - templates.json（实体模板）
  - effect templates
  - GASGraph programs（技能/效果图）
- Phase 3：地图加载（Map Load）
  - 合并 MapConfig（Core+Mods+Parent）
  - 数据集裁决：Hex(Vertex) 对最终地图唯一；Grid/Graph 可多份并存
  - 加载数据集：Hex/Grid/Graph（均可选）
  - 装配实体：模板先、Overrides 后
- Phase 4：地图后初始化（Post-Map）
  - 触发 MapLoaded，所有后续系统在此事件后读取上下文并初始化

## 3.2 MapLoaded 上下文契约（目标形态）

- 必选：
  - MapId / MapTags
  - Engine / World / Spatial services
- 可选（按地图裁决结果存在与否判断）：
  - Hex：VertexMap（可空）
  - Grid：GridRegistry（可空或为空）
  - Graph：GraphRegistry（可空或为空）

## 3.3 失败策略（目标口径）

- Phase 2：全局注册表加载失败应能定位具体文件（例如 graphs.bin 缺失只跳过、引用未知 effect template 应 fail-fast）。
- Phase 3：地图加载失败必须输出证据：
  - mapId、来源片段、字段名（DataFile/DataSets）、候选路径、冲突项（若有）

# 4 数据模型
## 4.1 “叠加”发生的阶段

- 叠加只允许发生在 Phase 3（Map Load）：
  - MapConfig 叠加（Core/Mods/Parent）
  - DataSets 叠加（Grid/Graph 多份；Hex 唯一裁决）
  - Entities 叠加（列表追加）
- 运行期（Phase 4 之后）不允许“隐式叠加/静默覆盖”，必须通过显式系统与可追踪的修改通道实现（例如 overlay）。

## 4.2 运行期 overlay 与加载期真源的边界

- 加载期真源：Hex/Grid/Graph 的基础数据（地图资产提供）。
- 运行期 overlay：只允许以可追踪方式叠加（GraphEdgeCostOverlay、天气系统对 Grid 的更新等）。

# 5 落地方式
## 5.1 代码落地点（现状）

- 引擎初始化与全局注册表加载：`GameEngine.InitializeCoreSystems()` 内部已加载 templates/effects/GASGraph programs。
- MapLoaded 触发点：`GameEngine.LoadMap()` 末尾触发 MapLoaded。

## 5.2 差距清单

- 缺少“数据集裁决”阶段：目前 Hex 依赖 DataFile 直接加载且无“最终地图维度唯一性”裁决；Grid/Graph 未纳入地图加载阶段。
- Graph 路网未注入 MapLoaded 上下文；Grid coarse/fine 运行时容器未定义。

## 5.3 迁移策略与风险

- 先补齐契约与文档：统一时序与上下文键，避免系统在错误阶段取数据。
- 再接入加载器：优先接入 Graph 路网（基建成熟），再补 Grid coarse/fine（先容器后资产格式）。

# 8 验收条款

- MapLoaded 事件触发前，Hex/Grid/Graph/实体装配均已完成；事件后系统只消费最终结果。
- 任意地图可缺省 Hex/Grid/Graph 任意一种；缺省时上下文可明确判断，而不是靠默认值猜测。
- 叠加只在 Map Load 发生；运行期叠加必须通过 overlay 或显式系统，且可追踪可诊断。
