---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 六边形地图系统
状态: 草案
---

# 六边形地图系统 架构设计

# 1 设计概述
## 1.1 本文档定义

本文档定义当前版本的六边形/三角网格地形表示：VertexMap（按 chunk 稀疏存储的顶点多层数据）及其几何投影方式，用于渲染、导航与可行走性分析的上游输入口径。

边界与非目标：

- 边界：只讨论 VertexMap 与 Hex 坐标/几何投影，不讨论具体渲染管线与平台 Adapter。
- 非目标：不在本文档设计编辑器工具链与地形生成器（见 `03_地图生成器.md`）。

## 1.2 设计目标

- 地形真源：提供高度/水面/阻挡/坡道等基础层，供渲染与导航使用。
- 稀疏与局部性：按 chunk 存储，支持局部访问与缓存。
- 可版本化：二进制格式具备 magic/version，避免运行时猜测。

## 1.3 设计思路

- 以“顶点多层数据”为中心：将地形表达为一张顶点网（VertexMap），通过规则把其投影为三角面片与派生语义（颜色、阻挡、坡道等）。
- 通过 chunk 化存储保证访问局部性：q/r 坐标按位移分配到 VertexChunk，支持最近 chunk 缓存。

# 2 功能总览
## 2.1 术语表

- (c,r)：VertexMap 上的二维坐标（实现上作为 q/r 输入）。
- Chunk：固定尺寸的块（`VertexChunk.ChunkSize`），以 2D 坐标右移分块。
- Layer：高度/生物群系/水面/植被/阻挡/坡道/阵营/额外 flags 等。

## 2.2 功能导图

- 读取/写入 VertexMapBinary
- 按 (c,r) 查询地形层（height/biome/water/blocked/ramp/…）
- 将 (c,r) 投影到 3D 世界坐标（用于 mesh 构建与高度采样）

## 2.3 架构图

```
VertexMapBinary <-> VertexMap <-> VertexChunk
                      |
                      v
           VertexMapChunkMeshBuilder / NavMesh 等消费方
```

## 2.4 关联依赖

- 二进制格式：`src/Core/Map/Hex/VertexMapBinary.cs`
- chunk 数据结构：`src/Core/Map/Hex/VertexChunk.cs`
- 几何参数：`src/Core/Map/Hex/HexCoordinates.cs`
- 渲染投影：`src/Core/Presentation/Rendering/VertexMapChunkMeshBuilder.cs`

# 3 业务设计
## 3.1 业务用例与边界

- 用例：加载 VertexMapBinary 后，渲染系统按 chunk 构建网格；导航系统按阻挡/坡道等层做可行走性判定。
- 边界：VertexMap 只提供基础场信息，不直接承载“玩法命名”（例如技能区域、阵营关系等）。

## 3.2 业务主流程

```
LoadVertexMap(MapConfig.DataFile)
  -> VertexMapBinary.Read(stream)
  -> (运行期) 渲染/导航按 chunk 访问 VertexMap 层数据
```

## 3.3 关键场景与异常分支

- chunk 越界：按地图维度做边界检查，越界访问返回默认值或失败（当前实现多处选择返回默认值）。
- 采样高度：当前以最近邻方式计算逻辑高度，插值与更精确的三角网采样属于后续工作。

# 4 数据模型
## 4.1 概念模型

- VertexMap：以 (c,r) 为索引的顶点层集合，按 chunk 存储。
- VertexChunk：承载固定大小区域的所有层数据与派生数据（例如 cliff straighten）。

## 4.2 数据结构与不变量

- `VertexMap.WidthInChunks/HeightInChunks` 定义边界；所有访问应在边界内。
- `VertexMapBinary` 强约束：magic/version/chunkSize 必须匹配。
- Layer 读写应具备默认值语义（例如未加载 chunk 时 height=0）。

## 4.3 生命周期/状态机

- 未初始化：Width/Height 默认值存在，但 chunk 字典为空。
- 初始化：加载二进制或显式 Initialize 后，维度确定并清空旧 chunk。
- 运行期：读取为主；写入通常只应出现在编辑器/工具链或明确的运行期修改系统。

# 5 落地方式
## 5.1 模块划分与职责

- VertexMap：chunk 管理与层访问 API；提供最近 chunk 缓存。
- VertexMapBinary：二进制读写与版本校验。
- 消费方：渲染/导航根据自身需求读取层并派生结果（mesh、navmesh 等）。

## 5.2 关键接口与契约

- `VertexMap.GetChunk(q, r, createIfMissing)`：边界外返回 null；边界内按需创建。
- `VertexMapChunkMeshBuilder.BuildChunk`：按 (chunkX,chunkY) 构建该 chunk 的可渲染 mesh 数据。

## 5.3 运行时关键路径与预算点

- 高频查询：GetHeight/IsBlocked 等可能出现在导航/碰撞/采样热点；需要关注 chunk 缓存命中率与默认值分支的隐性成本。

# 6 与其他模块的职责切分
## 6.1 切分结论

- WorldMap 与 VertexMap 并存时，必须明确“哪个系统依赖哪个真源”，避免同一语义被两套数据重复表达。

## 6.2 为什么如此

两套地形表示若缺乏边界，会导致可行走性/渲染/碰撞使用不一致的数据源，出现“看得见走不过去/走得过去看不见”的口径漂移。

## 6.3 影响范围

- 消费方需要明确其依赖的地形真源，并在 MapLoaded 之后从 ContextKeys 获取对应对象。

# 7 当前代码现状
## 7.1 现状入口

- `src/Core/Map/Hex/VertexMap.cs`
- `src/Core/Map/Hex/VertexMapBinary.cs`
- `src/Core/Presentation/Rendering/VertexMapChunkMeshBuilder.cs`

## 7.2 差距清单

- 高度采样插值未实现：`VertexMap.GetLogicHeight` 仍为最近邻（TODO）。
- 坐标单位口径未在地图目录内文档化：HexCoordinates 的几何参数与引擎“厘米域”口径需要对齐说明。

## 7.3 迁移策略与风险

- 先补齐“单位/真源/消费方边界”文档约束，再做插值与更强的加载期校验，避免在口径未定时做性能/精度优化。

# 8 验收条款

- `VertexMapBinary` 对 magic/version/chunkSize 的校验必须可通过构造坏文件验证（单测/工具验证均可）。
- 消费方从 ContextKeys 获取 VertexMap 时，必须能区分“未加载”和“已加载但高度为 0”的情况（避免默认值掩盖错误）。
- 任何新增 Layer 必须同时更新二进制格式与消费方规则，并在加载期暴露版本变化（不得静默兼容）。
