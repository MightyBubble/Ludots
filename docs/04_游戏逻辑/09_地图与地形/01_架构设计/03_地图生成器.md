---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 游戏逻辑 - 地图与地形 - 地图生成器
状态: 草案
---

# 地图生成器 架构设计

# 1 设计概述
## 1.1 本文档定义

本文档定义“地图生成器/工具链”的目标口径：如何从编辑器/数据源生成 MapConfig（JSON）与 VertexMapBinary（VTXM），并产出可被 Core+Mods 按一致路径加载的地图资产。

边界与非目标：

- 边界：只定义工具链产物与接口，不定义具体 UI 编辑器与美术工作流。
- 非目标：不为历史格式提供静默兼容；迁移应通过显式工具/一次性转换完成。

## 1.2 设计目标

- 可复现：同输入应生成同输出（二进制/JSON 可追踪）。
- 可校验：生成阶段即可校验 schema、版本与边界（避免运行期才暴雷）。
- 可扩展：支持 Mod 自定义地形 layer 与生成规则（通过版本化与显式扩展点）。

## 1.3 设计思路

- 以“加载器口径”为约束反推工具链：生成器必须产出加载器能直接消费的格式与路径。
- 生成阶段强校验：把缺文件/版本错/边界错尽量前置到 build 阶段。

# 2 功能总览
## 2.1 术语表

- Source：生成输入（高度图、规则、手工编辑等）。
- Artifact：生成输出（MapConfig JSON、VertexMapBinary、派生预计算数据）。
- Pack：资产打包与分发（Core 或 Mod 的 assets 结构）。

## 2.2 功能导图

- 输入采集：高度/阻挡/水面/生物群系等
- 生成 VertexMapBinary：写入 VTXM（version、chunkSize、layers）
- 生成 MapConfig：引用 DataFile、提供 Tags/Entities 等
- 产出路径校验：确保落到加载器候选路径可命中

## 2.3 架构图

```
Source -> Generator -> (MapConfig.json + VertexMap.vtxm) -> Pack(Core/Mod assets) -> Loader
```

## 2.4 关联依赖

- VertexMapBinary：`src/Core/Map/Hex/VertexMapBinary.cs`
- MapConfig schema：`src/Core/Config/MapConfig.cs`
- 加载候选路径：`src/Core/Engine/GameEngine.cs`（LoadVertexMap）

# 3 业务设计
## 3.1 业务用例与边界

- 用例：生成一个可运行的地图资产包，使其在加载期能确定性地读取 MapConfig 与地形二进制。
- 边界：生成器不应把“运行期合并逻辑”搬到生成期；生成期只负责产出合法片段与校验。

## 3.2 业务主流程

```
Generate(mapId, source)
  -> Validate(source)
  -> Build VertexMap (in-memory)
  -> VertexMapBinary.Write(outputStream)
  -> Build MapConfig (DataFile + Tags + Entities)
  -> Validate artifacts against loader conventions
```

## 3.3 关键场景与异常分支

- 维度不一致：source 的边界与 chunk 维度不一致时直接失败。
- schema 不匹配：MapConfig 字段类型错误时直接失败。
- 版本升级：输出格式版本变更时必须显式 bump 并给迁移工具入口。

# 4 数据模型
## 4.1 概念模型

- 输入模型（source）→ 地形模型（VertexMap）→ 输出模型（VTXM + MapConfig）

## 4.2 数据结构与不变量

- 输出二进制必须满足 `VertexMapBinary` 的 magic/version/chunkSize 不变量。
- MapConfig 的 `DataFile` 必须能在加载器候选路径内命中。

## 4.3 生命周期/状态机

- 编辑中 → 生成中 → 校验中 → 已产出（可加载）

# 5 落地方式
## 5.1 模块划分与职责

- Generator Core：将 source 转为 VertexMap 并写入二进制。
- Validator：校验 schema/版本/路径/边界。
- Packager：把产物放入 Core/Mod 的 assets 结构。

## 5.2 关键接口与契约

- 输入契约：明确 source 的单位、坐标系与边界定义。
- 输出契约：严格遵守 MapConfig/VertexMapBinary 的格式约束。

## 5.3 运行时关键路径与预算点

- 生成阶段应以离线为主；运行期不应承担重计算与格式猜测。

# 6 与其他模块的职责切分
## 6.1 切分结论

- 生成器负责“产出合法资产”，加载器负责“按约定读取与装配”；两者通过格式与路径契约解耦。

## 6.2 为什么如此

把校验前置到生成阶段能显著降低运行期不确定性，并符合“禁止静默 fallback”的整体架构风格。

## 6.3 影响范围

- Mod 作者需要使用统一工具链或遵循同一格式契约生成资产。

# 7 当前代码现状
## 7.1 现状入口

- `src/Core/Map/Hex/VertexMapBinary.cs` 提供 Write，但仓库内缺少对应的离线生成入口与资产目录约束文档。

## 7.2 差距清单

- 缺少标准地图二进制资产目录（例如 `assets/Data/Maps/`）与示例 VTXM 文件。
- 缺少“生成期校验工具”，导致运行期只能靠日志/异常发现问题。

## 7.3 迁移策略与风险

- 先补齐：标准资产目录 + 示例地图二进制 + 最小校验工具（CLI/测试）。
- 再落地：地图编辑/生成工作流与 Mod 扩展点。

# 8 验收条款

- 仓库内至少提供 1 个可被加载器命中的 VTXM 示例资产与对应 MapConfig 引用（集成验证）。
- 生成器/校验工具能在生成阶段捕获 schema 不匹配与文件缺失（自动化验证）。
- 格式版本升级必须通过显式版本号与迁移工具完成（不得静默兼容）。
