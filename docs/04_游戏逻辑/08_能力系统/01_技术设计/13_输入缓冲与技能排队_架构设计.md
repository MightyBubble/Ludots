---
文档类型: 架构设计
创建日期: 2026-02-09
最后更新: 2026-02-09
维护人: X28技术团队
文档版本: v0.1
适用范围: 技能排队 / 输入缓冲
状态: 设计中
---
# 输入缓冲与技能排队 — 架构设计

## 1 现状

当前 `OrderSubmitter.Submit()` 在 Order 被 Tag 阻断（如 GCD/施法中）时返回 `Blocked`，Order 被丢弃。没有"在 GCD 末尾自动重试"机制。

WoW/MOBA 等游戏允许在当前技能/GCD 最后 N ms 内预输入下一技能。

## 2 核心设计

### 2.1 PendingBuffer

在 `OrderBuffer` 组件上新增 Pending 区域（或独立 `PendingOrderBuffer` 组件）：

```csharp
public struct PendingOrderSlot
{
    public Order Order;
    public int ExpireStep;   // 超时后自动丢弃
    public bool IsValid;
}

// 在 OrderBuffer 中追加
public PendingOrderSlot PendingSlot; // 仅保留 1 个（最后一次按键覆盖前一次）
```

### 2.2 提交流程修改

```
OrderSubmitter.Submit():
  → 正常检查...
  → 若结果 == Blocked 且 order.OrderTagId 是技能类:
    → 计算 pending 过期步 = currentStep + (PendingBufferWindowMs * stepRateHz / 1000)
    → 存入 PendingSlot（覆盖已有 pending）
  → 返回 OrderSubmitResult.Pending (新增枚举值)
```

### 2.3 重试触发点

两个触发点：
1. **AbilityExecSystem 完成时**：调用 `OrderSubmitter.NotifyOrderComplete()`（当前缺失，需补上），NotifyOrderComplete 内部检查 PendingSlot 并重试
2. **OrderBufferSystem.Update() 每帧**：检查 PendingSlot 是否过期，未过期则尝试 Submit

### 2.4 关键修复：AbilityExecSystem 完成通知

当前 `AbilityExecSystem` 在技能完成时（`AbilityExecRunState.Finished`）未调用 `OrderSubmitter.NotifyOrderComplete()`。需要补上：

```csharp
// AbilityExecSystem.cs - 技能完成处理
if (instance.RunState == AbilityExecRunState.Finished)
{
    OrderSubmitter.NotifyOrderComplete(World, entity, _orderTypeRegistry);
    // ... 移除 AbilityExecInstance
}
```

## 3 配置

```json
{
  "pendingBufferWindowMs": 400,
  "enablePendingBuffer": true,
  "pendingOnlyForSkills": true
}
```

`pendingBufferWindowMs`：默认 400ms（WoW 标准值），可配置。

## 4 OrderSubmitResult 扩展

```csharp
public enum OrderSubmitResult
{
    Activated = 0,
    Queued = 1,
    Blocked = 2,
    // ...existing...
    Pending = 6  // 新增：已存入 PendingBuffer，等待重试
}
```
