---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 附录与扩展 - 工程指南 - AI 工作流
状态: 草案
---

# AI 工作流

# 1 目标

沉淀在 Ludots 架构下，AI 助手与开发者最常见的工作流与检查项：确保修改遵循 Mod-First、平台无关、ECS 可预算与确定性等裁决口径，并能用命令快速验证。

# 2 全局必查清单

## 2.1 先找真源

- SSOT：对应能力域的 `00_总览.md` 与规范文档（禁止平行叙事）。
- 代码入口：文档里必须列出 `src/...` 文件路径，避免“猜入口”。
- 依赖边界：是否跨层（底层框架/核心引擎/基础服务/游戏逻辑/交互层）。

## 2.2 架构裁决必守

- Mod-First：内容与扩展点优先走 Mod/VFS/配置管线，不在 Core 写死内容。
- 平台无关：Core 不引用平台 API；平台相关逻辑放 Adapter/Platform/App。
- ECS 约束：热路径 0GC、结构变更安全阶段、组件以值类型为主。
- 确定性：稳定序与 tie-break 固定；不依赖容器遍历顺序；预算超限必须可观测。
- fail-fast：配置/版本/缺文件必须在加载期失败，不做静默 fallback。

# 3 常见工作流

## 3.1 新增或修改玩法逻辑（优先写 Mod）

适用：新增单位能力、规则、配置、触发器响应等。

必须检查：

- 是否能用配置表达（`assets/Configs/...` + 合并规则），而不是硬编码。
- 是否需要扩展点（Trigger/Graph Node/Registry），扩展点是否可文档化。
- 是否把平台/渲染/输入耦合进了玩法裁决路径。

建议步骤：

1. 在 `assets/Mods/{ModName}/` 新增或修改配置与资源。
2. 需要代码扩展时，在 Mod DLL 内实现扩展点（保持平台无关）。
3. 更新对应能力域 SSOT 文档的“验收条款/接口规范/配置结构”。

推荐命令（可复制）：

```bash
dotnet run --project src/Tools/ModLauncher/Ludots.ModLauncher.csproj -c Release -- cli sdk export
dotnet run --project src/Tools/ModLauncher/Ludots.ModLauncher.csproj -c Release -- cli mods build --mod ExampleMod
dotnet run --project src/Tools/ModLauncher/Ludots.ModLauncher.csproj -c Release -- cli gamejson write --mod ExampleMod
dotnet run --project src/Tools/ModLauncher/Ludots.ModLauncher.csproj -c Release -- cli run
```

## 3.2 扩展空间查询 / 导航 / AI 使用的候选查询

适用：索敌、避障、寻路输入、可见性裁剪等。

必须检查：

- 是否使用空间服务门面（`src/Core/Spatial/SpatialQueryService.cs`）而不是直接绑物理/地图细节。
- 查询是否支持固定容量输出（buffer + dropped），是否写明退化策略。
- 是否定义稳定序与 tie-break（特别是候选裁剪/排序）。

建议步骤：

1. 先更新接口规范：`docs/03_基础服务/06_空间服务/03_空间查询接口.md`。
2. 再在 Core 内实现后端或 Adapter，并补齐 dropped/visited 指标。
3. 为上层系统（行为 AI/避障）补齐对齐报告与用例。

## 3.3 编辑器与离线管线产物接入（地图/导航/图编译）

适用：Web 编辑器产物导入、地图测试数据生成、Graph 编译等。

必须检查：

- 产物格式与版本号是否定义（配置结构或工具设计文档）。
- 输出路径是否落在 `assets/Data/...` 并且可被运行时通过 VFS 读取。
- 工具是否 fail-fast（缺文件/版本不匹配直接失败，错误信息可定位）。

推荐命令（可复制）：

```bash
dotnet run --project src/Tools/Ludots.Tool/Ludots.Tool.csproj -- map import-react --in <path-to-map_data.bin> --name <mapId> --force
dotnet run --project src/Tools/Ludots.Tool/Ludots.Tool.csproj -- map gen-vtxm --out assets/Data/Maps/test.vtxm --widthChunks 16 --heightChunks 16 --chunkSize 64 --preset bench --overwrite
dotnet run --project src/Tools/Ludots.Tool/Ludots.Tool.csproj -- graph compile --mod <modId>
```

# 4 最佳实践（必须注意）

## 4.1 Mod 写实现，但保持平台无关

- Mod DLL 可以实现扩展点与玩法规则，但不得引用平台渲染/输入类型。
- 需要平台能力时，通过 Core 的抽象接口或事件/命令通道交由 Adapter 处理。

## 4.2 ECS 最佳实践

- 组件使用结构体与紧凑字段，避免 `class`、`List<T>`、闭包捕获。
- Query 遍历中禁止结构变更（增删组件/创建销毁实体）。
- 热路径不允许 LINQ，避免隐藏分配与不稳定序。

## 4.3 文档先于实现的最小闭环

- 新增功能至少同时落地一个“接口规范/配置结构/裁决条款”的 SSOT 文档。
- 设计与实现冲突时，先写对齐报告，再改代码。

# 5 代码入口索引

- Mod/VFS：`src/Core/Modding/`
- ModLauncher CLI：`src/Tools/ModLauncher/Cli/`
- Ludots.Tool CLI：`src/Tools/Ludots.Tool/Program.cs`
- 空间服务：`src/Core/Spatial/`
- 导航：`src/Core/Navigation/`
- ECS：`src/Libraries/Arch/`、`src/Libraries/Arch.Extended/`

