---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 底层框架 - ECS基础 - Arch ECS 核心概念
状态: 草案
---

# Arch ECS 核心概念

# 1 背景与问题定义

Ludots 以 Arch ECS 作为运行时数据组织与系统调度的基础设施。本文明确最低心智模型与性能边界，避免在上层系统里引入不可控的 GC 与内存飞线。

# 2 设计目标与非目标

目标：

- 连续内存布局与可预测遍历成本
- 批处理友好、可并行化
- 结构变更与生命周期可控（通过集中通道执行）

非目标：

- 不把 ECS 当脚本对象系统使用
- 不为任何业务语义提供特例（业务必须以数据与系统实现）

# 3 核心设计

## 3.1 模块划分与职责

- Arch Core：World/Entity/Query/Chunk 等基础抽象
- Arch Extended：扩展能力（事件、持久化、关系等）

代码入口：

- `src/Libraries/Arch/`
- `src/Libraries/Arch.Extended/`

## 3.2 数据流与依赖关系

系统以 Query 扫描组件数据，读取/写入尽量局部化到当前 archetype 的线性内存。跨实体关系通过显式索引或关系组件表达，避免托管集合飞线。

## 3.3 关键决策与取舍

- 组件必须以值类型为主（避免 `class`/`List<T>`），热路径零 GC
- 结构变更（增删组件、创建/销毁实体）集中到安全阶段执行，避免遍历中修改导致崩溃
- 并行查询只能写当前实体数据，不写全局共享状态

# 4 替代方案对比

替代方案（Unity.Entities / 自研 ECS）在工程成熟度与约束形态上不同，但对本项目“百万级单位、可预算、跨平台”的核心约束并无本质差异：需要可预测内存与确定性执行边界。

# 5 风险与迁移策略

- 风险：上层用托管集合或隐式分配破坏 0GC
- 策略：在各系统文档的“验收条款”里固化 0GC 与预算约束，并通过测试覆盖

# 6 验收条款

- 任何热路径系统在稳定场景下 0GC（测试可自动化）
- 结构变更不允许发生在 Query 遍历中（必须走集中通道）
- 组件不包含引用类型字段（除非明确标注为冷数据并隔离）

