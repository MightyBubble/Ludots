---
文档类型: 对齐报告
创建日期: 2026-02-05
最后更新: 2026-02-06
维护人: X28技术团队
文档版本: v0.2
适用范围: 基础服务 - 空间服务 - Design vs Code
状态: 草案
依赖文档:
  - docs/00_文档总览/01_文档规范/15_对齐报告.md
  - docs/03_基础服务/06_空间服务/01_架构设计/01_空间服务_架构设计.md
---

# 空间服务 对齐报告

# 1 摘要

## 1.1 结论

空间服务的基础骨架已存在（统一 Query 门面、可插拔 backend、增量索引维护、裁剪消费者），但与“64km 大世界”目标相比存在三项 P0/P1 差距：加载一致性（LoadedChunks 真源）、玩法/表现解耦、增量索引峰值风险。

## 1.2 风险等级与影响面

- P0：LoadedChunks 真源未统一，可能导致查询与加载不一致（严重一致性 bug）。
- P1：表现侧裁剪走玩法域稳定序路径，引入额外 n log n 成本（峰值风险）。
- P1：增量索引在高密移动场景可能出现 remove 退化（峰值风险）。

## 1.3 建议动作

1. 先落地裁决条款与验收用例，把口径固定为可判定标准。
2. 再推进实现对齐：LoadedChunks 真源、CullingQuery 独立路径、容器策略与指标观测。

# 2 审计范围与方法

## 2.1 审计范围

- 空间查询：`src/Core/Spatial/`（门面、后端接口、后处理口径）
- 索引维护：`src/Core/Systems/SpatialPartitionUpdateSystem.cs`
- 表现侧裁剪：`src/Core/Systems/CameraCullingSystem.cs`
- AOI/GraphWorld：`src/Core/Navigation/AOI/`、`src/Core/Navigation/GraphWorld/`

## 2.2 审计方法

1. 以代码入口为真源列出模块清单。
2. 对照架构设计与裁决条款，登记差异与风险。

## 2.3 证据口径

证据必须使用仓库相对路径（`src/...`、`docs/...`），不使用本机绝对路径与 file:// 链接。

# 3 差异表

## 3.1 差异表

| 设计口径 | 代码现状 | 差异等级 | 风险 | 证据 |
|---|---|---|---|---|
| LoadedChunks 单一真源驱动生命周期 | chunk 语义分散在 AOI/Spatial/GraphWorld，缺少统一真源接口 | P0 | 查询与加载不一致 | `src/Core/Navigation/AOI/`、`src/Core/Spatial/ChunkedGridSpatialPartitionWorld.cs`、`src/Core/Navigation/GraphWorld/ChunkedNodeGraphStore.cs` |
| 玩法域与表现域查询解耦 | 门面统一做稳定序去重，表现侧可能承担额外成本 | P1 | 峰值帧耗不可控 | `src/Core/Spatial/SpatialQueryService.cs`、`src/Core/Systems/CameraCullingSystem.cs` |
| 增量索引峰值受控 | cell 容器策略可能存在 remove 退化风险 | P1 | 局部高密移动峰值 | `src/Core/Spatial/ChunkedGridSpatialPartitionWorld.cs` |
| 玩法域确定性（三角函数/方向计算） | **已修复**（2026-02-06）：`Atan2Deg` / `SinCosDeg` 已替换为 `Fix64Math.Atan2Fast` + `MathUtil.Sin/Cos` 查表法 | ✅ 已消除 | — | `src/Core/Spatial/SpatialQueryService.cs` |
| positionProvider fail-fast | **已修复**（2026-02-06）：`QueryCone` / `QueryRectangle` / `QueryLine` 入口增加 null 检查 | ✅ 已消除 | — | `src/Core/Spatial/SpatialQueryService.cs` |

# 4 行动项

## 4.1 行动项清单

| 行动项 | 负责人 | 优先级 | 验收条件 |
|---|---|---|---|
| 定义并落地 LoadedChunks 真源接口与 enter/exit 语义 | 待定 | P0 | `docs/03_基础服务/06_空间服务/04_裁决条款/01_AOI与Chunk_裁决条款.md` 的规则可通过用例验证 |
| 引入表现域 CullingQuery 独立输出口径（固定容量 + dropped） | 待定 | P1 | 表现域不依赖玩法域排序路径；指标可观测 |
| 补齐高密移动压力测试与峰值指标观测 | 待定 | P1 | `docs/03_基础服务/06_空间服务/06_测试用例/01_64km_空间服务_测试用例.md` 可重复通过 |
