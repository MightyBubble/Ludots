---
文档类型: 测试用例
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 基础服务 - 空间服务 - 64km 验收
状态: 草案
依赖文档:
  - docs/00_文档总览/01_文档规范/16_测试用例.md
  - docs/03_基础服务/06_空间服务/04_裁决条款/01_AOI与Chunk_裁决条款.md
  - docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md
  - docs/03_基础服务/06_空间服务/02_接口规范/01_空间查询接口_接口规范.md
---

# 64km 空间服务 验收 测试用例

# 1 测试目标

## 1.1 对应需求/裁决条款

- AOI/Chunk：LoadedChunks 单一真源、enter/exit 生命周期语义、禁止隐式加载  
  证据：`docs/03_基础服务/06_空间服务/04_裁决条款/01_AOI与Chunk_裁决条款.md`
- 可见性/time-slice：先粗裁剪、tick 真源、固定容量输出与 dropped 可观测  
  证据：`docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md`

## 1.2 覆盖范围

- QueryAabb / QueryRadius 的固定容量输出与 dropped 行为
- 未加载 chunk 的一致性行为（不返回、不隐式加载）
- time-slice 的可观测指标与上限形态（若实现）

# 2 前置条件

## 2.1 环境与版本

- 运行环境：仅需逻辑 tick 与空间服务可调用；不要求渲染或物理引擎
- 版本：以当前仓库 `src/` 为准

## 2.2 数据与初始状态

1. 一个最小世界实例：WorldSizeSpec（边界 + cellSizeCm）
2. 至少 N 个带 `WorldPositionCm` 的实体（N 用于覆盖溢出与高密场景）
3. 一个空间查询后端与门面服务实例（ISpatialQueryBackend + ISpatialQueryService）

# 3 测试步骤

## 3.1 步骤列表

### 用例 A：Query 固定容量与 dropped

1. 创建输出 buffer，容量设为 0、1、16 三档
2. 调用 QueryAabb（或 QueryRadius），记录 `Count` 与 `Dropped`
3. 断言：
   - `Count <= buffer.Length`
   - 当候选数超过容量时 `Dropped > 0`

### 用例 B：未加载 chunk 不得被查询返回（若存在 LoadedChunks 管线）

1. 构造 AOI/LoadedChunks，使目标实体所在 chunk 处于未加载状态
2. 调用 QueryAabb 覆盖该区域
3. 断言：返回结果不包含未加载 chunk 的实体

### 用例 C：time-slice 上限（若实现）

1. 设置 time-slice interval（例如 60 tick）
2. 连续执行 60 个 tick
3. 每 tick 记录：VisibleCellCount、ProcessedCellCount、Dropped

# 4 预期结果

## 4.1 可观察信号

- Query：`SpatialQueryResult.Count`、`SpatialQueryResult.Dropped`
- 可见性：VisibleCellCount / VisibleChunkCount（若实现）
- 分帧：ProcessedCellCount / ProcessedEntityCount（若实现）

## 4.2 判定标准

1. 用例 A 必须通过：固定容量约束成立，溢出可观测
2. 用例 B 若具备 LoadedChunks 管线必须通过：不返回未加载实体，不隐式加载
3. 用例 C 若实现 time-slice 必须通过：processed 指标存在硬上限并可观测

# 5 回归关联

## 5.1 相关用例/缺陷/对齐报告链接

- 对齐报告：`docs/03_基础服务/06_空间服务/05_对齐报告/01_空间服务_对齐报告.md`

# 6 自动化状态

## 6.1 自动化入口与触发方式

- 当前状态：未接入自动化（待实现）
- 建议入口：将用例 A/B/C 分别落地为单元测试与集成测试，放入 `src/Tests/`
