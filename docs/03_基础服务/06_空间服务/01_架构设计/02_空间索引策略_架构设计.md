---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 基础服务 - 空间服务 - 空间索引策略
状态: 草案
依赖文档:
  - docs/00_文档总览/01_文档规范/11_架构设计.md
  - docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md
---

# 空间索引策略 架构设计

# 1 设计概述

## 1.1 本文档定义

本文档定义空间服务运行时必须支持的两类空间索引策略（GridBuckets 与增量索引），并说明它们在大世界（64km*64km 2D）下的适用边界、成本模型与落地方式。

## 1.2 设计目标

1. 让表现域裁剪与分帧更新具备可控上限：优先使用分桶/区间遍历实现 time-slice。
2. 让玩法域空间查询具备即时性与确定性：无需每次查询都重建分桶。
3. 把溢出与降级显式化：固定容量输出 + dropped 可观测，禁止隐式扩容。

## 1.3 设计思路

1. 双路径并存：玩法域优先增量索引；表现域与分帧优先 GridBuckets。
2. 不依赖容器遍历顺序：任何排序/裁剪都必须定义稳定键与 tie-break。
3. 默认 fail-fast：索引未准备好时不得静默 fallback 为全表扫描。

# 2 功能总览

## 2.1 术语表

| 术语 | 定义 |
|---|---|
| 增量索引 | 实体移动时增量更新其所在 cell 的集合。 |
| GridBuckets | 通过计数 + 前缀和构建的分桶数组区间（cellStarts + cellEntities）。 |
| 宽相位 | 先用粗粒度索引得到候选集，再做精确过滤。 |
| TimeSlice | 按 cell/chunk 切片，把每 tick 的处理成本变为可控上限。 |

## 2.2 功能导图

```
输入实体位置（WorldPositionCm）
  │
  ├─► 增量索引：Move → Remove/Add
  │      └─► 玩法域 Query（确定性）
  │
  └─► GridBuckets：Count/Scan/Fill
         └─► 表现域 Culling / TimeSlice（近似/限额）
```

## 2.3 架构图

```
SpatialIndex
  ├─ IncrementalIndex
  │    - cell -> entities
  │    - entity -> SpatialCellRef（派生缓存）
  └─ GridBuckets
       - cellCounts / cellStarts / cellEntities
```

## 2.4 关联依赖

- 可见性与分帧更新裁决：`docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md`

# 3 业务设计

## 3.1 业务用例与边界

用例：

1. 玩法域：技能范围、触发器、AI 需要随时 QueryAabb/QueryRadius。
2. 表现域：相机裁剪与 LOD 需要大量候选筛选，并要求可控上限。
3. 分帧系统：远距或视野外单位的更新要能按 bucket 切片。

边界：

- 索引策略不决定业务过滤语义；过滤条件由上层 token/ID 提供。

## 3.2 业务主流程

```
TickBegin
  ├─ IndexUpdate（增量移动 / 构建 buckets）
  ├─ Gameplay Query（增量索引 + 确定性）
  └─ Culling/TimeSlice（buckets + 上限）
TickEnd
```

## 3.3 关键场景与异常分支

1. 高密 + 高频移动：增量索引 remove 退化风险必须可观测并被验收覆盖。
2. 未构建 buckets：表现域不得退化为全表扫描；要么显式降级，要么 fail-fast。

# 4 数据模型

## 4.1 概念模型

| 模块 | 输入 | 输出 |
|---|---|---|
| 增量索引 | entity move | cell -> entities |
| GridBuckets | entities snapshot | cell 区间 -> entities |

## 4.2 数据结构与不变量

1. GridBuckets 构建过程必须 deterministic：遍历顺序固定或以稳定键归并。
2. Query 输出固定容量，溢出以 dropped 表示。

## 4.3 生命周期/状态机

```
GridBuckets 生命周期（按 tick）
  Unbuilt → Building → Built → Discarded
```

# 5 落地方式

## 5.1 模块划分与职责

1. IncrementalIndex：由索引维护系统驱动，适合动态移动实体。
2. GridBuckets：由预算系统驱动，适合 time-slice 与可见性粗裁剪。

## 5.2 关键接口与契约

索引策略必须对外统一暴露为“空间查询接口”，而不是让上层直接操作索引结构。
接口契约见：`docs/03_基础服务/06_空间服务/02_接口规范/01_空间查询接口_接口规范.md`

## 5.3 运行时关键路径与预算点

1. Buckets 构建：计数/前缀和/填充必须可预算化（可按 chunk 分帧）。
2. Incremental move：Remove/Add 不得出现不可控峰值；若存在峰值，必须可观测并可降级。

# 6 与其他模块的职责切分

## 6.1 切分结论

- 表现域裁剪不强制走玩法域确定性路径。
- 物理宽相位可复用分桶思想，但输出口径独立于空间查询接口。

## 6.2 为什么如此

把“确定性”强加给表现域会引入不必要成本；把“近似/限额”引入玩法域会破坏回放一致性。

## 6.3 影响范围

影响模块包括空间查询、裁剪系统、分帧系统与任何依赖候选集的 AI/玩法逻辑。

# 7 当前代码现状

## 7.1 现状入口

- 增量索引：`src/Core/Spatial/ChunkedGridSpatialPartitionWorld.cs`
- 索引维护：`src/Core/Systems/SpatialPartitionUpdateSystem.cs`

## 7.2 差距清单

1. GridBuckets 作为 runtime 级输出形态尚未形成统一实现与接口。
2. 高密移动场景的峰值风险需要通过容器策略与验收覆盖。

## 7.3 迁移策略与风险

迁移优先级：先落地接口与裁决条款，再引入 buckets 实现；避免先做优化后补口径导致分叉。

# 8 验收条款

| 条款 | 验证方法 | 证据入口 |
|---|---|---|
| 表现域 time-slice 上限可控 | 指标/日志 | `docs/03_基础服务/06_空间服务/06_测试用例/01_64km_空间服务_测试用例.md` |
| 玩法域查询可复现 | 回放对比 | `src/Core/Spatial/` |
| buckets 未准备不静默退化 | 断言/错误码 | `src/Core/Spatial/` |
