---
文档类型: 架构设计
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 基础服务 - 空间服务 - 总体架构
状态: 草案
依赖文档:
  - docs/00_文档总览/01_文档规范/11_架构设计.md
  - docs/03_基础服务/06_空间服务/02_接口规范/01_空间查询接口_接口规范.md
  - docs/03_基础服务/06_空间服务/04_裁决条款/01_AOI与Chunk_裁决条款.md
  - docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md
---

# 空间服务 架构设计

# 1 设计概述

## 1.1 本文档定义

本文档定义“空间服务（Spatial Service）”在本项目中的职责边界、主流程、数据模型与落地方式，并给出与现有代码的差距清单与验收条款。

空间服务的核心价值是让“超大世界（64km*64km 2D）”下的空间查询、AOI/Chunk、可见性与分帧更新具备一致口径、可控成本与可审计边界。

## 1.2 设计目标

1. 避免 O(N) 全表扫描成为常态：通过空间索引与分桶/分帧策略把峰值成本变成可控上限。
2. 玩法域确定性：同输入、同 tick 下的查询结果可复现（稳定序与 tie-break 固定）。
3. 表现域可预算：可见性/裁剪允许近似与限额，但必须固定容量输出并可观测 dropped。
4. 单一真源：LoadedChunks 驱动空间索引与导航/地图数据的一致生命周期，禁止隐式加载与静默 fallback。

## 1.3 设计思路

1. 坐标真源使用厘米域：世界位置组件以厘米为真源，索引空间（cell/chunk）为派生缓存。
2. 双路径输出：玩法域 SpatialQuery（确定性）；表现域 CullingQuery（近似/限额）。
3. 大世界优先级：先统一 AOI/Chunk 的口径与生命周期，再做索引结构优化。

# 2 功能总览

## 2.1 术语表

| 术语 | 定义 |
|---|---|
| WorldPositionCm | 世界位置真源（厘米域）。 |
| Cell | 细粒度桶，用于快速候选查询与分帧切片。 |
| Chunk | 宏粒度分块，用于加载/预算/索引生命周期边界。 |
| LoadedChunks | 当前世界实例已加载并参与模拟/查询的 chunk 集合（单一真源）。 |
| SpatialQuery | 玩法域空间查询：稳定序/去重、固定容量输出。 |
| CullingQuery | 表现域候选集获取：允许近似/不排序，但必须固定容量 + dropped。 |

## 2.2 功能导图

```
WorldPositionCm（真源）
  │
  ▼
IndexUpdate（增量索引 / 分桶构建）
  │
  ├─► SpatialQuery（玩法域：确定性）
  │      │
  │      └─► Simulation（AI/技能/移动等）
  │
  └─► CullingQuery（表现域：近似/限额）
         │
         └─► Presentation（相机/LOD/可见性消费）
```

## 2.3 架构图

```
┌──────────────────────────────────────────────────────────────┐
│ WorldRuntime                                                  │
│ - WorldSizeSpec（不可变）                                     │
│ - LoadedChunks（AOI 真源）                                     │
└──────────────────────────────────────────────────────────────┘
                │ enter/exit 驱动生命周期
                ▼
┌──────────────────────────────────────────────────────────────┐
│ SpatialIndex                                                  │
│ - Incremental Index（移动增量更新）                             │
│ - GridBuckets（分桶数组，用于 time-slice/culling）               │
└──────────────────────────────────────────────────────────────┘
                │
                ├─► SpatialQuery（确定性输出）
                └─► CullingQuery（近似/限额输出）
```

## 2.4 关联依赖

- 可见性与分帧更新裁决：`docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md`
- AOI/Chunk 口径裁决：`docs/03_基础服务/06_空间服务/04_裁决条款/01_AOI与Chunk_裁决条款.md`
- 空间查询接口：`docs/03_基础服务/06_空间服务/02_接口规范/01_空间查询接口_接口规范.md`

# 3 业务设计

## 3.1 业务用例与边界

用例：

1. 玩法域命中/范围查询：技能、触发器、AI 需要在 tick 内获取候选实体（确定性优先）。
2. 表现域裁剪：相机/LOD 需要候选集与可见性输入（成本上限优先）。
3. 大世界 streaming：AOI 推动 chunk 加载/卸载，空间索引与导航/地图数据随之创建/回收。

边界：

- 空间服务不做业务过滤语义（阵营/标签等由上层 token/ID 提供）。
- 空间服务不隐式触发加载；加载由 AOI/Streaming 显式驱动。

## 3.2 业务主流程

```
TickBegin
  ├─ AOI Update：计算 LoadedChunks（enter/exit）
  ├─ Streaming Apply：处理加载/卸载
  ├─ Index Update：增量更新或构建 buckets
  ├─ Gameplay SpatialQuery：确定性查询
  ├─ Simulation：AI/技能/移动
  └─ CullingQuery：可见性与候选集（近似/限额）
TickEnd
```

## 3.3 关键场景与异常分支

1. 越界位置：必须 fail-fast（抛异常或错误码），禁止静默 clamp。
2. 未加载 chunk 查询：必须返回明确空/错误码，禁止隐式加载或静默 fallback 为全表扫描。
3. 查询溢出：必须通过 dropped 可观测，禁止隐式扩容掩盖问题。

# 4 数据模型

## 4.1 概念模型

```
Entity
  ├─ WorldPositionCm（真源）
  ├─ SpatialCellRef（派生缓存）
  └─ 其他业务组件

World
  ├─ WorldSizeSpec（不可变）
  ├─ LoadedChunks（真源）
  └─ SpatialIndex（派生结构）
```

## 4.2 数据结构与不变量

1. WorldSizeSpec 创建后不可变。
2. SpatialCellRef 只能由 IndexUpdate 维护，业务代码不得直接写入。
3. Query 输出固定容量，溢出必须以 dropped 表示。

## 4.3 生命周期/状态机

```
Chunk 生命周期（受 LoadedChunks 驱动）
  Unloaded
    ├─ enter → Loading → Loaded
    └─ exit  → Unloading → Unloaded
```

# 5 落地方式

## 5.1 模块划分与职责

1. AOI/Streaming：维护 LoadedChunks，产生 enter/exit。
2. SpatialIndex：维护索引结构（增量/分桶）。
3. Query Service：对外暴露统一接口，负责输出口径（确定性/限额）。

## 5.2 关键接口与契约

关键接口在接口规范中定义：
`docs/03_基础服务/06_空间服务/02_接口规范/01_空间查询接口_接口规范.md`

## 5.3 运行时关键路径与预算点

预算点：

1. IndexUpdate：每 tick 更新/构建的上限必须可控（按 cell/chunk 切片）。
2. Query：固定容量输出 + dropped；不得分配临时容器。
3. Culling：不得强制复用玩法域的排序/去重路径，避免额外 n log n。

# 6 与其他模块的职责切分

## 6.1 切分结论

- 玩法域确定性属于空间服务的硬约束，但业务过滤语义不属于空间服务。
- 表现域裁剪属于表现层的消费逻辑，但候选集与可见性输入属于空间服务输出契约的一部分。

## 6.2 为什么如此

1. 业务语义变化频繁，放入空间服务会导致接口膨胀与不可控依赖。
2. 大世界的性能上限与一致性必须在底座统一裁决，否则上层无法收敛。

## 6.3 影响范围

影响模块包括 Spatial、AOI、CameraCullingSystem 以及任何依赖空间查询的 AI/玩法系统。

# 7 当前代码现状

## 7.1 现状入口

- 空间服务代码：`src/Core/Spatial/`
- AOI 代码：`src/Core/Navigation/AOI/`
- 裁剪消费者：`src/Core/Systems/CameraCullingSystem.cs`

## 7.2 差距清单

1. 玩法域与表现域的查询路径尚未显式解耦（需在接口与实现层落地）。
2. LoadedChunks 的单一真源需要从裁决条款落地到各子系统生命周期中。
3. 增量索引在高密移动场景的峰值风险需要通过容器策略与验收覆盖。

## 7.3 迁移策略与风险

迁移策略优先以“裁决条款 + 验收用例”收敛口径，再做实现切换。
风险以“差距清单”中三项为 P0/P1 级风险，必须在对齐报告与测试用例中可追踪。

# 8 验收条款

| 条款 | 验证方法 | 证据入口 |
|---|---|---|
| Query 固定容量 + dropped 可观测 | 单测/日志指标 | `src/Tests/`（若缺失需补） |
| 玩法域稳定序可复现 | 固定输入回放对比 | `src/Core/Spatial/` |
| 未加载 chunk 不隐式查询成功 | 集成测试 | `docs/03_基础服务/06_空间服务/06_测试用例/01_64km_空间服务_测试用例.md` |
