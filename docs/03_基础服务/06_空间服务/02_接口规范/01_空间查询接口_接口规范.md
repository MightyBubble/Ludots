---
文档类型: 接口规范
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 基础服务 - 空间服务 - 空间查询接口
状态: 草案
依赖文档:
  - docs/00_文档总览/01_文档规范/12_接口规范.md
  - docs/03_基础服务/06_空间服务/04_裁决条款/02_可见性与分帧更新_裁决条款.md
---

# 空间服务 接口规范

# 1 概述

## 1.1 本文档定义

本文档定义空间服务的对外空间查询接口与后端契约，包含：签名、参数约束、容量与预算、失败策略、线程安全性，以及代码入口。

## 1.2 术语与约定

- 单位：所有空间输入默认使用厘米域（WorldCm），不使用浮点世界坐标。
- 候选集：空间查询返回的是“可能候选”（粗粒度），不承诺业务语义过滤。
- 固定容量：调用方提供 `Span<Entity>` 作为输出 buffer；实现不得分配临时集合。

## 1.3 关键约束

1. 输出固定容量：溢出必须通过 `Dropped` 可观测，禁止隐式扩容。
2. 默认 fail-fast：越界与缺失依赖不得静默 fallback。
3. 稳定序：玩法域查询必须稳定排序与去重（由门面服务保证）。

# 2 核心接口

## 2.1 ISpatialQueryService

### 签名

`ISpatialQueryService` 定义统一的空间查询门面：

- `SpatialQueryResult QueryAabb(in WorldAabbCm bounds, Span<Entity> buffer)`
- `SpatialQueryResult QueryRadius(WorldCm2 center, int radiusCm, Span<Entity> buffer)`

### 参数说明

#### QueryAabb

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| bounds | `in WorldAabbCm` | cm | 查询范围（轴对齐包围盒）。 |
| buffer | `Span<Entity>` | 容量 >= 0 | 输出 buffer，最多写入 `buffer.Length` 个实体。 |

#### QueryRadius

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| center | `WorldCm2` | cm | 查询圆心（厘米）。 |
| radiusCm | `int` | cm，>=0 | 半径（厘米）。 |
| buffer | `Span<Entity>` | 容量 >= 0 | 输出 buffer，最多写入 `buffer.Length` 个实体。 |

### 返回值

返回 `SpatialQueryResult`：

| 字段 | 含义 |
|---|---|
| Count | 实际写入 `buffer` 的数量。 |
| Dropped | 因 buffer 容量不足而被丢弃的数量（可用于诊断与验收）。 |
| Overflowed | `Dropped > 0` 的快捷判断。 |

### 异常/错误码

当前接口返回值不包含错误码，异常策略由实现裁决：
默认约束是 fail-fast（越界、缺失依赖等不允许静默 fallback）。
具体裁决见：`docs/03_基础服务/06_空间服务/04_裁决条款/01_AOI与Chunk_裁决条款.md`。

### 线程安全性

- 默认：非线程安全。
- 调用方必须保证在同一逻辑线程/同一世界实例的安全阶段内调用。

## 2.2 ISpatialQueryBackend

### 签名

`ISpatialQueryBackend` 定义空间索引后端契约：

- `int QueryAabb(in WorldAabbCm bounds, Span<Entity> buffer, out int dropped)`
- `int QueryRadius(WorldCm2 center, int radiusCm, Span<Entity> buffer, out int dropped)`

### 参数说明

#### QueryAabb

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| bounds | `in WorldAabbCm` | cm | 查询范围。 |
| buffer | `Span<Entity>` | 容量 >= 0 | 输出候选实体（可含重复）。 |
| dropped | `out int` | >=0 | 因容量不足丢弃数量。 |

#### QueryRadius

| 参数名 | 类型 | 单位或取值范围 | 说明 |
|---|---|---|---|
| center | `WorldCm2` | cm | 圆心。 |
| radiusCm | `int` | cm，>=0 | 半径。 |
| buffer | `Span<Entity>` | 容量 >= 0 | 输出候选实体（可含重复）。 |
| dropped | `out int` | >=0 | 因容量不足丢弃数量。 |

### 返回值

返回值为本次写入 `buffer` 的数量。
注意：backend 可以返回包含重复的候选；去重与稳定序由门面服务负责。

### 异常/错误码

backend 不得隐式分配或隐式扩大容量。
越界/未加载 chunk 等失败策略由裁决条款统一规定，backend 必须遵守。

### 线程安全性

- 默认：非线程安全。
- 若 backend 支持并行内部实现，必须对调用方表现为纯只读快照输出。

# 3 使用约束

## 3.1 生命周期与所有权

- `buffer` 的所有权属于调用方；空间服务只写入，不保留引用。
- `Entity` 的有效性由调用方按世界生命周期保证；跨帧持有需要使用项目统一的 EntityReference（若存在）。

## 3.2 容量与预算

1. Query 输出容量由 `buffer.Length` 决定；实现必须写满优先级最高的候选（若有排序/裁剪规则）。
2. `Dropped` 是验收信号：出现 dropped 表示容量或预算不足，需要通过分桶/分帧/缩小范围等策略解决。

## 3.3 失败策略

1. 禁止静默 fallback（例如未命中索引时退化为全表扫描）。
2. 未加载 chunk 的数据不得被查询返回；若发生，视为一致性 bug。

# 4 代码入口

## 4.1 接口定义位置

- `src/Core/Spatial/ISpatialQueryService.cs`
- `src/Core/Spatial/ISpatialQueryBackend.cs`
- `src/Core/Spatial/SpatialQueryResult.cs`

## 4.2 关键实现位置

- 门面实现：`src/Core/Spatial/SpatialQueryService.cs`
- 稳定序与去重：`src/Core/Spatial/SpatialQueryPostProcessor.cs`

## 4.3 相关测试与对齐文档

- 对齐报告：`docs/03_基础服务/06_空间服务/05_对齐报告/01_空间服务_对齐报告.md`
- 测试用例：`docs/03_基础服务/06_空间服务/06_测试用例/01_64km_空间服务_测试用例.md`
