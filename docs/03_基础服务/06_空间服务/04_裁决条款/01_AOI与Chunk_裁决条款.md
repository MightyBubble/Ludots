---
文档类型: 裁决条款
创建日期: 2026-02-05
最后更新: 2026-02-05
维护人: X28技术团队
文档版本: v0.1
适用范围: 基础服务 - 空间服务 - AOI/Chunk/Streaming
状态: 草案
依赖文档:
  - docs/00_文档总览/01_文档规范/14_裁决条款.md
---

# AOI 与 Chunk 裁决条款

# 1 裁决背景

## 1.1 背景问题与约束

在 64km*64km（2D）大世界中，空间索引、导航/路网、地图与地形数据必须按 chunk 进行生命周期管理。
如果 AOI/Chunk 的口径不统一，会出现两类高风险问题：

1. 查询与加载不一致：加载了但查不到，或未加载却能查到。
2. 隐式加载与静默 fallback：导致成本上限不可控，破坏可回放与可审计边界。

## 1.2 适用范围与边界

适用范围：

- 任何以 chunk 为单位加载/卸载的数据：地图/地形、空间索引、导航数据、表现域缓存。

边界：

- 本裁决不规定 AOI 算法（圆形/扇形/多中心等），只裁决输入输出与生命周期语义。
- 本裁决不绑定物理/渲染/导航具体实现。

# 2 裁决结论

## 2.1 必须遵守的规则

1. LoadedChunks 必须是单一真源（Single Source of Truth）。
2. Enter/Exit 表示生命周期边界：
   - Enter 后该 chunk 数据必须可被查询并参与模拟。
   - Exit 后该 chunk 数据必须被卸载/冻结且不得再被查询返回。
3. 空间查询不得隐式触发加载；缺失 chunk 数据时必须返回明确空/错误码。
4. ChunkKey 编码必须全工程统一：
   `key = ((long)chunkX << 32) | (uint)chunkY`

## 2.2 例外条件与退出条件

例外：表现域允许使用“近似可见性”进行裁剪（例如只依赖 VisibleChunks 进行渲染裁剪），但必须满足：

- 不得改变 LoadedChunks。
- 不得让未加载 chunk 的实体进入玩法域查询结果。

退出条件：当表现域需要更强的一致性或 debug 需求时，必须回到“加载一致性优先”的规则，不再使用近似路径作为真源。

# 3 裁决理由

## 3.1 为什么这样做

1. 大世界的第一性能风险来自“生命周期不一致”而非单点算法优劣。
2. 单一真源能让诊断与测试闭环成立：任何不一致都可被验收用例捕获。

## 3.2 放弃了哪些备选方案

1. 每个子系统维护自己的活跃 chunk 集合：会产生不可控分叉。
2. Query 未命中时隐式触发加载或静默全表扫描：会破坏成本上限与一致性。

# 4 影响范围

## 4.1 受影响模块与代码入口

- AOI：`src/Core/Navigation/AOI/`
- Chunked SpatialIndex：`src/Core/Spatial/ChunkedGridSpatialPartitionWorld.cs`
- GraphWorld：`src/Core/Navigation/GraphWorld/ChunkedNodeGraphStore.cs`
- 查询门面：`src/Core/Spatial/SpatialQueryService.cs`

## 4.2 迁移与过渡策略

1. 先在测试用例中定义“未加载 chunk 不得被查询返回”的可判定标准。
2. 再对各子系统逐步对齐：任何私建活跃集必须改为消费 LoadedChunks。

证据入口：

- 测试用例：`docs/03_基础服务/06_空间服务/06_测试用例/01_64km_空间服务_测试用例.md`
- 对齐报告：`docs/03_基础服务/06_空间服务/05_对齐报告/01_空间服务_对齐报告.md`
