---
文档类型: 架构设计
创建日期: 2026-02-06
最后更新: 2026-02-06
维护人: X28技术团队
文档版本: v1.0
适用范围: 03_基础服务 - 07_物理系统 - 定点数数学
状态: 已实现
依赖文档:
  - docs/03_基础服务/07_物理系统/00_总览.md
---

# 定点数数学库 架构设计

# 1 设计概述

## 1.1 本文档定义

本文档定义 Ludots 定点数数学库的架构设计，包括 Fix64/Fix64Vec2/Fix64Math 等核心类型。

边界：

- 定点数基础运算与向量计算
- 物理/逻辑层位置、速度的数值表示

非目标：

- 不替换表现层浮点数（VisualTransform 仍为 float）
- 不改造碰撞检测核心算法（使用桥接转换）

## 1.2 设计目标

- 完全确定性：相同输入产生完全相同输出，跨平台一致
- 消除舍入抖动：物理和逻辑使用统一的定点数类型
- 高精度：Q31.32 格式提供纳米级精度
- 零成本抽象：内联优化，性能接近原生浮点

## 1.3 设计思路

采用 FixPointCS 库的 Q31.32 格式，源码嵌入而非 NuGet 依赖。Ludots 封装层提供友好的 API，底层委托给 FixPointCS 实现。

# 2 功能总览

## 2.1 术语表

| 术语 | 定义 |
|------|------|
| Q31.32 | 32位整数部分 + 32位小数部分的定点数格式 |
| Fix64 | Ludots 封装的64位定点数结构体 |
| Fix64Vec2 | Ludots 封装的2D定点数向量 |
| Fixed64 | FixPointCS 原始实现类 |

## 2.2 功能导图

- 基础运算：加减乘除、取模、绝对值
- 比较运算：大于、小于、等于、Clamp
- 数学函数：Sqrt、Sin、Cos、Atan2、Lerp
- 向量运算：Dot、Cross、Length、Normalize、Distance

## 2.3 架构图

```text
┌───────────────────────────────────────┐
│         Ludots 封装层                   │
│  ┌─────────┐ ┌──────────┐ ┌─────────┐ │
│  │  Fix64  │ │ Fix64Vec2│ │Fix64Math│ │
│  └────┬────┘ └────┬─────┘ └────┬────┘ │
└───────┼───────────┼────────────┼──────┘
        │           │            │
        ▼           ▼            ▼
┌───────────────────────────────────────┐
│        FixPointCS 原始实现              │
│  ┌─────────┐ ┌─────────┐ ┌──────────┐ │
│  │ Fixed64 │ │ Fixed32 │ │ FixedUtil│ │
│  └─────────┘ └─────────┘ └──────────┘ │
└───────────────────────────────────────┘
```

## 2.4 关联依赖

上游依赖：无

下游消费：

- `src/Core/Ludots.Physics2D/` - Position2D, Velocity2D
- `src/Core/Components/` - WorldPositionCm

# 3 业务设计

## 3.1 业务用例与边界

用例1：物理积分 - 使用 Fix64Vec2 进行位置 += 速度 * dt 计算
用例2：渲染插值 - 使用 Fix64Vec2.Lerp 在两帧位置间插值
用例3：距离计算 - 使用 Fix64Vec2.Distance 计算实体间距离

边界：仅服务于需要确定性的逻辑/物理层计算。

## 3.2 业务主流程

```text
物理积分流程：
1. IntegrationSystem2D 读取 Velocity2D (Fix64Vec2)
2. 计算 position += velocity * Fix64.FromFloat(dt)
3. 写入 Position2D (Fix64Vec2)
4. Physics2DToWorldPositionSyncSystem 直接赋值到 WorldPositionCm
```

## 3.3 关键场景与异常分支

| 场景 | 处理方式 |
|------|----------|
| 溢出 | Q31.32 范围 ±21亿，超出范围 fail-fast |
| 除零 | 返回 Fix64.MaxValue 或 Fix64.MinValue |
| NaN/Inf | 定点数无此概念，自然避免 |

# 4 数据模型

## 4.1 概念模型

Fix64：64位有符号整数，高32位为整数部分，低32位为小数部分。
Fix64Vec2：两个 Fix64 组成的2D向量 (X, Y)。

## 4.2 数据结构与不变量

| 字段 | 类型 | 不变量 |
|------|------|--------|
| Fix64.RawValue | long | 原始定点数值 |
| Fix64Vec2.X | Fix64 | X 分量 |
| Fix64Vec2.Y | Fix64 | Y 分量 |

## 4.3 生命周期/状态机

无状态，纯值类型。

# 5 落地方式

## 5.1 模块划分与职责

| 模块 | 职责 | 路径 |
|------|------|------|
| Fix64 | 64位定点数封装 | `src/Core/Math/FixedPoint/Fix64.cs` |
| Fix64Vec2 | 2D定点数向量 | `src/Core/Math/FixedPoint/Fix64Vec2.cs` |
| Fix64Math | 数学函数 | `src/Core/Math/FixedPoint/Fix64Math.cs` |
| Fixed64 | FixPointCS 核心 | `src/Core/Math/FixedPoint/Fixed64.cs` |
| Fixed32 | FixPointCS 32位 | `src/Core/Math/FixedPoint/Fixed32.cs` |
| FixedUtil | FixPointCS 工具 | `src/Core/Math/FixedPoint/FixedUtil.cs` |

## 5.2 关键接口与契约

转换接口：

- Fix64.FromInt(int) / Fix64.ToInt()
- Fix64.FromFloat(float) / Fix64.ToFloat()
- Fix64Vec2.FromVector2(Vector2) / Fix64Vec2.ToVector2()

运算接口：

- Fix64 +/-/*// 运算符（委托 Fixed64）
- Fix64Vec2.Lerp / Dot / Cross / Length / Normalize

## 5.3 运行时关键路径与预算点

热路径：IntegrationSystem2D 每物理帧对所有动态实体执行积分

预算：1000 实体 × 6 次定点数乘法 < 0.1ms

# 6 与其他模块的职责切分

## 6.1 切分结论

| 模块 | 定点数库职责 | 其他模块职责 |
|------|--------------|--------------|
| Physics2D | 提供 Fix64Vec2 位置/速度 | 碰撞检测使用桥接转换 |
| Presentation | 提供 Fix64.ToFloat() | 渲染使用浮点 |

## 6.2 为什么如此

碰撞检测对确定性要求较低，改动成本高；仅核心积分路径使用定点数。

## 6.3 影响范围

需适配的系统：IntegrationSystem2D, FieldDetectorSystem, UpdateMotionSystem, ApplyImpulsesSystem2D, Physics2DToWorldPositionSyncSystem, WorldToVisualSyncSystem

# 7 当前代码现状

## 7.1 现状入口

- 定点数库：`src/Core/Math/FixedPoint/`
- 物理组件：`src/Core/Ludots.Physics2D/Components/`
- 逻辑组件：`src/Core/Components/Components.cs`

## 7.2 差距清单

| 项目 | 状态 |
|------|------|
| Fix64/Fix64Vec2/Fix64Math | 已实现 |
| Position2D/Velocity2D 定点化 | 已实现 |
| WorldPositionCm 定点化 | 已实现 |
| 碰撞检测定点化 | 未实现（使用桥接） |

## 7.3 迁移策略与风险

风险：碰撞检测仍为浮点，边界转换可能引入微小误差
策略：碰撞结果仅用于物理响应，不用于逻辑裁决

# 8 验收条款

| 条款 | 验证方法 | 证据入口 |
|------|----------|----------|
| 相同输入序列产生相同输出 | 录像回放测试 | 待补充测试用例 |
| 编译通过，Physics2DPlaygroundMod 可运行 | dotnet build + 启动验证 | `src/Mods/Physics2DPlaygroundMod/` |
| 1000 实体场景性能回归 < 10% | 基准测试 | 待补充测试用例 |
